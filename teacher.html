<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>교사 대시보드</title>
  <style>
    *,*::before,*::after{ box-sizing:border-box; }
    select,button,input,textarea{ font:inherit; }
    :root{ font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR","Malgun Gothic",sans-serif; color-scheme:dark; }
    body{ margin:0; background:#0b1220; color:#e5e7eb; }
    header{ background:#1e3a8a; color:#fff; padding:12px 16px; }
    header .sub{ font-size:12px; opacity:.9; margin-top:4px; }
    main{ max-width:1200px; margin:20px auto; padding:0 16px; }

    .tabs{ display:flex; gap:8px; margin:8px 0 16px; }
    .tab{ background:#0f172a; border:1px solid #334155; color:#e5e7eb; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .tab.active{ background:#2563eb; border-color:#2563eb; }
    .card{ background:#0f172a; border:1px solid #334155; border-radius:14px; padding:14px; }

    .row{ display:flex; gap:8px; flex-wrap:nowrap; align-items:center; }
    @media (max-width:1024px){ .row{ flex-wrap:wrap; } }
    .grid{ display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:12px; }
    .col-3{grid-column:span 3;} .col-4{grid-column:span 4;} .col-5{grid-column:span 5;}
    .col-6{grid-column:span 6;} .col-8{grid-column:span 8;} .col-9{grid-column:span 9;} .col-12{grid-column:span 12;}

    input[type="text"],input[type="number"],select,textarea{
      width:100%; padding:10px 12px; border:1px solid #334155; border-radius:10px; background:#0b1220; color:#e5e7eb;
    }
    textarea{ min-height:160px; white-space:pre; }
    .btn{ border:1px solid #64748b; background:#0f172a; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn.primary{ background:#2563eb; border-color:#2563eb; }
    .btn.warn{ background:#991b1b; border-color:#ef4444; }
    .btn.gray{ background:#111827; }

    .muted{ color:#93a4b5; font-size:12px; }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; background:#172554; border:1px solid #334155; font-size:12px; }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    table{ width:100%; border-collapse:collapse; }
    th,td{ border-bottom:1px solid #233043; padding:8px 10px; text-align:left; }
    th{ background:#0c1527; position:sticky; top:0; z-index:1; }
    .right{text-align:right;}

    .hidden{ display:none!important; }
    .ok{ color:#60a5fa; } .bad{ color:#f87171; }
  </style>
</head>
<body>
  <header>
    <div style="font-weight:800">교사 대시보드</div>
    <div class="sub">
      인증: <span id="authState">-</span>
      · UID: <span id="uid">-</span>
      · <span id="who">권한 확인 중…</span>
    </div>
  </header>

  <main>
    <div class="tabs">
      <button class="tab active" data-tab="settings">설정</button>
      <button class="tab" data-tab="live">실시간 결과</button>
      <button class="tab" data-tab="sum">합산 결과</button>
    </div>

    <!-- 설정 탭 -->
    <section id="tab-settings" class="card">
      <div class="grid">
        <div class="col-3">
          <label>classId</label>
          <input id="classId" type="text" placeholder="예) 6-1" />
          <div class="muted">문서: <code>configs/<span id="cfgDoc">-</span></code></div>
          <div class="muted">권한 없는 경우 삭제/저장 비활성</div>
        </div>
        <div class="col-4">
          <label>set</label>
          <input id="setId" type="text" placeholder="예) lesson1" />
        </div>
        <div class="col-5">
          <label>세트 목록(해당 classId의 configs)</label>
          <div class="row">
            <select id="setList" style="flex:1 1 auto;"></select>
            <button id="btnReloadList" class="btn gray">목록 새로고침</button>
            <button id="btnLoad" class="btn">불러오기</button>
            <button id="btnDelete" class="btn warn">삭제</button>
          </div>
          <div class="muted">공개 세트는 (공개) 표시</div>
        </div>

        <div class="col-12">
          <label>단어 목록 (줄바꿈/띄어쓰기/쉼표 구분)</label>
          <textarea id="words"></textarea>
        </div>

        <div class="col-3">
          <label>라운드 수</label>
          <input id="rounds" type="number" min="1" value="5"/>
        </div>
        <div class="col-3">
          <label>속도 하한 (fastMin, px/s)</label>
          <input id="fastMin" type="number" min="100" value="420"/>
        </div>
        <div class="col-3">
          <label>속도 상한 (fastMax, px/s)</label>
          <input id="fastMax" type="number" min="150" value="520"/>
        </div>
        <div class="col-3">
          <label>최저 속도 바닥값 (minFloor, px/s)</label>
          <input id="minFloor" type="number" min="80" value="140"/>
        </div>

        <div class="col-12">
          <label class="row" style="gap:10px; align-items:center;">
            <input id="isPublic" type="checkbox" />
            <span>공개 세트 (누구나 선택 가능)</span>
          </label>
        </div>
      </div>

      <div class="toolbar" style="margin-top:12px;">
        <button id="btnParse" class="btn gray">입력값으로 불러오기</button>
        <button id="btnSave" class="btn primary">저장</button>
        <button id="btnStart" class="btn">세션 시작</button>
        <button id="btnNewRun" class="btn primary">새 판 시작(runId 리셋)</button>
        <button id="btnStop" class="btn warn">세션 중지</button>
        <span class="pill">runId: <span id="runIdView">없음</span></span>
      </div>

      <div class="muted" style="margin-top:8px;">
        문서는 <code>configs/{classId}_{set}</code> 에 저장/삭제됩니다.
      </div>
      <div id="status" class="muted" style="margin-top:6px;"></div>
    </section>

    <!-- 실시간 결과 탭 -->
    <section id="tab-live" class="card hidden">
      <div class="row" style="margin-bottom:10px;">
        <span class="pill">스트림 연결</span>
        <div style="flex:1"></div>
        <label class="row" style="gap:8px;">
          <span class="muted">보기 기준</span>
          <select id="liveMode">
            <option value="classSet">classId + set (이번 판만)</option>
            <option value="setOnly">set만(공개 세트용, runId 필터 없음)</option>
          </select>
        </label>
      </div>

      <div style="max-height:60vh; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>이름</th><th>SID</th><th>반</th><th>세트</th>
              <th>단어</th><th>시도</th><th>정답</th>
              <th class="right">점수</th><th>제출</th>
            </tr>
          </thead>
            <tbody id="liveTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- 합산 결과 탭 -->
    <section id="tab-sum" class="card hidden">
      <div class="row" style="margin-bottom:10px;">
        <div class="pill">로컬 집계</div>
        <div style="flex:1"></div>
        <label class="row" style="gap:8px;">
          <span class="muted">보기 기준</span>
          <select id="sumMode">
            <option value="classSet">classId + set (이번 판만)</option>
            <option value="setOnly">set만(공개 세트용, runId 필터 없음)</option>
          </select>
        </label>
        <button id="btnRefreshSum" class="btn gray">다시 집계</button>
      </div>

      <div style="max-height:60vh; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>이름</th><th>SID</th><th>반</th><th>세트</th>
              <th class="right">정답 수</th>
              <th class="right">총점</th>
              <th class="right">제출 수</th>
            </tr>
          </thead>
          <tbody id="sumTbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    /* ================= Firebase ================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
      collection, query, where, orderBy, limit, onSnapshot, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCUmSDDcFn45Z_ZH3UigbsothE6iD21C7Y",
      authDomain: "grade-6-english-c17f3.firebaseapp.com",
      projectId: "grade-6-english-c17f3",
      storageBucket: "grade-6-english-c17f3.appspot.com",
      messagingSenderId: "676305839050",
      appId: "1:676305839050:web:a5399633e7b828883fe533"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth= getAuth(app);

    /* ====== 권한: 허용된 교사 UID 목록 ====== */
    const ALLOWED_UIDS = new Set([
      "5lgNILjYd9eOICKua6vbm1hcRny2"
    ]);

    /* ================= DOM ================= */
    const $ = sel => document.querySelector(sel);
    const byId = id => document.getElementById(id);

    const tabs = document.querySelectorAll('.tab');
    const secSettings = byId('tab-settings');
    const secLive     = byId('tab-live');
    const secSum      = byId('tab-sum');

    const classIdEl = byId('classId');
    const setIdEl   = byId('setId');
    const cfgDocEl  = byId('cfgDoc');

    const setListEl = byId('setList');
    const wordsEl   = byId('words');
    const roundsEl  = byId('rounds');
    const fastMinEl = byId('fastMin');
    const fastMaxEl = byId('fastMax');
    const minFloorEl= byId('minFloor');
    const isPublicEl= byId('isPublic');

    const statusEl  = byId('status');

    const liveTbody = byId('liveTbody');
    const liveModeEl= byId('liveMode');

    const sumTbody  = byId('sumTbody');
    const sumModeEl = byId('sumMode');

    const authStateEl = byId('authState');
    const uidEl   = byId('uid');  const whoEl = byId('who');
    const runIdView = byId('runIdView');

    let currentUID = null;
    let CAN_EDIT = false;

    /* ================= Tabs ================= */
    tabs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tabs.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const key = btn.dataset.tab;
        secSettings.classList.toggle('hidden', key!=='settings');
        secLive.classList.toggle('hidden', key!=='live');
        secSum.classList.toggle('hidden', key!=='sum');
        if(key==='live') bindLive();
        if(key==='sum')  refreshSum();
      });
    });

    /* ================= Helpers ================= */
    const docId = ()=> `${(classIdEl.value||'').trim()}_${(setIdEl.value||'').trim()}`;
    const info = m => statusEl.textContent = m || '';
    const parseWords = (s)=> (s||'').replace(/[,\t]/g,' ').split(/\s+/).map(x=>x.trim()).filter(Boolean);
    function ensureEditable(){ if(!CAN_EDIT){ alert('이 작업은 교사 계정만 가능합니다.'); return false; } return true; }
    const newRunId = ()=> (crypto?.randomUUID?.() || `run_${Date.now()}_${Math.random().toString(36).slice(2,8)}`);

    async function readConfigOnce(){
      const id = docId();
      if(!id.includes('_')) return null;
      const s = await getDoc(doc(db,'configs',id));
      return s.exists()? s.data(): null;
    }
    function showRunId(v){ runIdView.textContent = v ? String(v) : '없음'; }

    /* ================= Auth ================= */
    onAuthStateChanged(auth, async u=>{
      if(!u){
        authStateEl.textContent = '로그인 필요 (구글 팝업 시도 → 실패 시 익명)';
        try{
          try{ await signInWithPopup(auth, new GoogleAuthProvider()); }
          catch{ await signInAnonymously(auth); }
        }catch(e){ console.error(e); }
        return;
      }
      currentUID = u.uid;
      uidEl.textContent = currentUID;
      CAN_EDIT = ALLOWED_UIDS.has(currentUID);
      whoEl.textContent = CAN_EDIT ? '교사 권한' : '읽기 전용';
      authStateEl.textContent = `로그인: ${u.displayName||'사용자'} (${u.email||'익명'})`;

      reloadSetList();
    });

    /* ================== Settings actions ================== */
    byId('btnReloadList').addEventListener('click', reloadSetList);
    byId('btnLoad').addEventListener('click', loadConfig);
    byId('btnDelete').addEventListener('click', async ()=>{
      if(!ensureEditable()) return;
      const id = docId();
      if(!confirm(`정말 삭제할까요?\nconfigs/${id}`)) return;
      try{
        await deleteDoc(doc(db,'configs',id));
        info('삭제 완료'); showRunId('');
        reloadSetList(); bindLive(); refreshSum();
      }catch(e){ console.error(e); info('삭제 실패'); }
    });

    byId('btnParse').addEventListener('click', ()=>{
      const arr = parseWords(wordsEl.value);
      wordsEl.value = arr.join('\n');
      info(`단어 ${arr.length}개로 정리됨`);
    });

    byId('btnSave').addEventListener('click', async ()=>{
      if(!ensureEditable()) return;
      const id = docId();
      if(!id.includes('_')){ alert('classId 와 set 을 먼저 입력하세요.'); return; }
      const words = parseWords(wordsEl.value);
      const data = {
        classId: classIdEl.value.trim(),
        set: setIdEl.value.trim(),
        words,
        rounds: Math.max(1, Number(roundsEl.value||1)),
        speedBase: {
          fastMin: Math.max(80, Number(fastMinEl.value||420)),
          fastMax: Math.max(100, Number(fastMaxEl.value||520)),
          minFloor: Math.max(60, Number(minFloorEl.value||140)),
        },
        public: !!isPublicEl.checked,
        updatedAt: new Date().toISOString()
      };
      try{
        await setDoc(doc(db,'configs',id), data, { merge:true });
        info(`저장 완료 (${id})`);
        reloadSetList();
      }catch(e){ console.error(e); info('저장 실패'); }
    });

    // 세션 시작: active=true, runId 없으면 생성
    byId('btnStart').addEventListener('click', async ()=>{
      if(!ensureEditable()) return;
      const id = docId();
      if(!id.includes('_')){ alert('classId/set 먼저 입력'); return; }
      try{
        const cur = await readConfigOnce();
        const runId = cur?.runId || newRunId();
        await setDoc(doc(db,'configs',id), { active:true, runId, updatedAt:new Date().toISOString() }, { merge:true });
        showRunId(runId);
        info('세션 시작 (active=true)');
        bindLive(); refreshSum();                      // ← 즉시 반영
      }catch(e){ console.error(e); info('세션 시작 실패'); }
    });

    // 새 판 시작: runId 무조건 교체 + active=true
    byId('btnNewRun').addEventListener('click', async ()=>{
      if(!ensureEditable()) return;
      const id = docId();
      if(!id.includes('_')){ alert('classId/set 먼저 입력'); return; }
      try{
        const runId = newRunId();
        await setDoc(doc(db,'configs',id), { active:true, runId, updatedAt:new Date().toISOString() }, { merge:true });
        showRunId(runId);
        info('새 runId 발급 완료 (이번 판 초기화)');
        bindLive(); refreshSum();                      // ← 즉시 반영
      }catch(e){ console.error(e); info('runId 발급 실패'); }
    });

    byId('btnStop').addEventListener('click', async ()=>{
      if(!ensureEditable()) return;
      const id = docId();
      if(!id.includes('_')){ alert('classId/set 먼저 입력'); return; }
      try{
        await updateDoc(doc(db,'configs',id), { active:false });
        info('세션 중지 (active=false)');
        bindLive(); refreshSum();
      }catch(e){ console.error(e); info('세션 중지 실패'); }
    });

    setListEl.addEventListener('change', ()=>{
      const v = setListEl.value;
      if(!v) return;
      setIdEl.value = v.replace(/^[^:]+:\s*/,'');  // "6-1: lesson1" → "lesson1"
      cfgDocEl.textContent = docId();
      loadConfig(); // 선택 시 바로 로드하여 runId 표시
    });
    classIdEl.addEventListener('input', ()=>{ cfgDocEl.textContent = docId(); showRunId(''); });
    setIdEl  .addEventListener('input', ()=>{ cfgDocEl.textContent = docId(); showRunId(''); });

    async function reloadSetList(){
      setListEl.innerHTML = '';
      const cid = (classIdEl.value||'').trim();
      if(!cid){ setListEl.innerHTML = `<option value="">(classId 입력)</option>`; return; }

      const q1 = query(collection(db,'configs'), where('classId','==',cid));
      const q2 = query(collection(db,'configs'), where('public','==',true));
      const [r1, r2] = await Promise.all([getDocs(q1), getDocs(q2)]);

      const items = new Map();
      r1.forEach(d=>items.set(`${d.data().classId}:${d.data().set}`, d.data()));
      r2.forEach(d=>items.set(`${d.data().classId}:${d.data().set}`, d.data()));

      if(items.size===0){
        setListEl.innerHTML=`<option value="">(없음)</option>`;
        return;
      }
      [...items.entries()].sort().forEach(([k,val])=>{
        const opt = document.createElement('option');
        opt.value = k.replace(/^.*?:\s*/,'');
        opt.textContent = `${val.classId}: ${val.set}${val.public?' (공개)':''}`;
        setListEl.appendChild(opt);
      });
      cfgDocEl.textContent = docId();
    }

    async function loadConfig(){
      const id = docId();
      if(!id.includes('_')){ info('classId/set 먼저 입력'); return; }
      try{
        const d = await readConfigOnce();
        if(!d){ info('문서 없음'); showRunId(''); return; }
        wordsEl.value = (d.words||[]).join('\n');
        roundsEl.value = d.rounds||5;
        fastMinEl.value = d?.speedBase?.fastMin ?? 420;
        fastMaxEl.value = d?.speedBase?.fastMax ?? 520;
        minFloorEl.value= d?.speedBase?.minFloor ?? 140;
        isPublicEl.checked = !!d.public;
        showRunId(d.runId||'');
        info(`불러오기 완료 (${id})`);
      }catch(e){ console.error(e); info('불러오기 실패'); }
    }

    /* ================== Live results (이번 판만) ================== */
    let liveUnsub = null;
    async function bindLive(){
      if(liveUnsub) liveUnsub();
      liveTbody.innerHTML = '';
      const cid=(classIdEl.value||'').trim(), sid=(setIdEl.value||'').trim();

      // setOnly 모드: runId 필터 없이 set만
      if(liveModeEl.value==='setOnly'){
        if(!sid){ liveTbody.innerHTML=`<tr><td colspan="9" class="muted">set 입력 필요</td></tr>`; return; }
        const qRef = query(collection(db,'results'),
          where('set','==',sid),
          orderBy('createdAt','desc'), limit(200));
        liveUnsub = onSnapshot(qRef, renderLive, onLiveErr);
        return;
      }

      // classSet 모드: runId 필요
      if(!cid || !sid){ liveTbody.innerHTML=`<tr><td colspan="9" class="muted">classId/set 입력 필요</td></tr>`; return; }
      const cfg = await readConfigOnce();
      const runId = cfg?.runId;
      showRunId(runId||'');
      if(!runId){
        liveTbody.innerHTML=`<tr><td colspan="9" class="muted">runId 없음: [세션 시작] 또는 [새 판 시작]을 눌러 주세요.</td></tr>`;
        return;
      }

      const qRef = query(collection(db,'results'),
        where('classId','==',cid),
        where('set','==',sid),
        where('runId','==',runId),
        orderBy('createdAt','desc'),
        limit(200));
      liveUnsub = onSnapshot(qRef, renderLive, onLiveErr);
    }

    function renderLive(snap){
      liveTbody.innerHTML='';
      snap.forEach(doc=>{
        const d = doc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHTML(d.name||'')}</td>
          <td>${escapeHTML(d.sid||'')}</td>
          <td>${escapeHTML(d.classId||'')}</td>
          <td>${escapeHTML(d.set||'')}</td>
          <td>${escapeHTML(d.word||'')}</td>
          <td class="right">${Number(d.attemptIndex??0)+1}</td>
          <td>${d.isCorrect?'<span class="ok">O</span>':'<span class="bad">X</span>'}</td>
          <td class="right">${Number(d.points||0)}</td>
          <td>${(d.createdAt?.toDate?.()||new Date()).toLocaleString('ko-KR')}</td>
        `;
        liveTbody.appendChild(tr);
      });
      if(!snap.size) liveTbody.innerHTML=`<tr><td colspan="9" class="muted">데이터 없음</td></tr>`;
    }
    function onLiveErr(err){
      console.error(err);
      liveTbody.innerHTML=`<tr><td colspan="9" class="muted">권한/색인 문제</td></tr>`;
    }
    liveModeEl.addEventListener('change', bindLive);
    classIdEl.addEventListener('input', ()=>{ cfgDocEl.textContent=docId(); showRunId(''); });
    setIdEl  .addEventListener('input', ()=>{ cfgDocEl.textContent=docId(); showRunId(''); });

    /* ================== Sum results (이번 판만) ================== */
    byId('btnRefreshSum').addEventListener('click', refreshSum);
    sumModeEl.addEventListener('change', refreshSum);

    async function refreshSum(){
      sumTbody.innerHTML='';
      const cid=(classIdEl.value||'').trim(), sid=(setIdEl.value||'').trim();

      // setOnly 모드: runId 필터 없이 set만
      if(sumModeEl.value==='setOnly'){
        if(!sid){ sumTbody.innerHTML=`<tr><td colspan="7" class="muted">set 입력 필요</td></tr>`; return; }
        const snap = await getDocs(query(collection(db,'results'),
          where('set','==',sid),
          orderBy('createdAt','desc'), limit(1000)));
        return buildSumFromSnap(snap);
      }

      // classSet 모드: runId 필요
      if(!cid || !sid){ sumTbody.innerHTML=`<tr><td colspan="7" class="muted">classId/set 입력 필요</td></tr>`; return; }
      const cfg = await readConfigOnce();
      const runId = cfg?.runId;
      showRunId(runId||'');
      if(!runId){ sumTbody.innerHTML=`<tr><td colspan="7" class="muted">runId 없음: [세션 시작] 또는 [새 판 시작]을 눌러 주세요.</td></tr>`; return; }

      const snap = await getDocs(query(collection(db,'results'),
        where('classId','==',cid),
        where('set','==',sid),
        where('runId','==',runId),
        orderBy('createdAt','desc'), limit(1000)));
      buildSumFromSnap(snap);
    }

    function buildSumFromSnap(snap){
      const map = new Map(); // key = sid|name|classId|set
      snap.forEach(doc=>{
        const d = doc.data();
        const key = [d.sid||'', d.name||'', d.classId||'', d.set||''].join('|');
        const cur = map.get(key) || { name:d.name||'', sid:d.sid||'', classId:d.classId||'', set:d.set||'', correct:0, points:0, count:0 };
        cur.count++;
        cur.points += Number(d.points||0);
        if(d.isCorrect) cur.correct++;
        map.set(key, cur);
      });

      const rows = [...map.values()].sort((a,b)=> b.points - a.points || (a.name>b.name?1:-1));
      sumTbody.innerHTML='';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHTML(r.name)}</td>
          <td>${escapeHTML(r.sid)}</td>
          <td>${escapeHTML(r.classId)}</td>
          <td>${escapeHTML(r.set)}</td>
          <td class="right">${r.correct}</td>
          <td class="right">${r.points}</td>
          <td class="right">${r.count}</td>
        `;
        sumTbody.appendChild(tr);
      });
      if(rows.length===0) sumTbody.innerHTML=`<tr><td colspan="7" class="muted">데이터 없음</td></tr>`;
    }

    /* ================= Utils ================= */
    function escapeHTML(s){ return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // 초기 상태
    cfgDocEl.textContent = docId();
  </script>
</body>
</html>
