<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>교사 대시보드</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f4f6fb;
    }
    header {
      background: #2563eb;
      color: #fff;
      padding: 12px 20px;
      font-size: 18px;
      font-weight: bold;
    }
    nav {
      background: #e5eaf3;
      padding: 8px 16px;
      display: flex;
      gap: 8px;
    }
    nav button {
      border: none;
      padding: 6px 14px;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-weight: 500;
    }
    nav button.active {
      background: #2563eb;
      color: #fff;
    }
    section {
      padding: 16px;
    }
    .panel {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,.08);
      padding: 12px;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #eceff5;
      text-align: left;
    }
    th {
      background: #f6f7fb;
    }
  </style>
</head>
<body>
  <header>교사 대시보드</header>
  <nav>
    <button id="tab-settings" class="active">설정</button>
    <button id="tab-live">실시간 결과</button>
    <button id="tab-sum">합산 결과</button>
  </nav>

  <!-- 설정 탭 -->
  <section id="settings">
    <div class="panel">
      <label>classId <input id="classIdInput" type="text" placeholder="예: 6-1"></label><br><br>
      <label>set <input id="setInput" type="text" placeholder="예: lesson1"></label><br><br>
      <label>단어 목록<br>
        <textarea id="wordsInput" rows="4" style="width:100%;"></textarea>
      </label><br><br>
      <label>라운드 수 <input id="roundsInput" type="number" value="5"></label><br><br>
      <label>속도 하한 <input id="fastMinInput" type="number" value="420"></label><br><br>
      <label>속도 상한 <input id="fastMaxInput" type="number" value="520"></label><br><br>
      <label>최저 속도 바닥값 <input id="minFloorInput" type="number" value="140"></label><br><br>
      <button id="saveBtn">저장</button>
      <button id="startBtn" style="background:#16a34a;color:#fff;">세션 시작</button>
      <button id="stopBtn" style="background:#dc2626;color:#fff;">세션 중지</button>
    </div>
  </section>

  <!-- 실시간 결과 탭 -->
  <section id="live" style="display:none;">
    <div class="panel">
      <h3>실시간 결과</h3>
      <table>
        <thead>
          <tr>
            <th>이름</th><th>SID</th><th>반</th><th>세트</th>
            <th>점수</th><th>정답/시도</th><th>소요</th><th>제출시각</th>
          </tr>
        </thead>
        <tbody id="liveTbody">
          <tr><td colspan="8">아직 결과 없음</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- 합산 결과 탭 -->
  <section id="sum" style="display:none;">
    <div class="panel">
      <h3>합산 결과(세트 종료 총점) <small id="sumMeta" style="opacity:.7;"></small></h3>
      <table>
        <thead>
          <tr>
            <th>이름</th><th>SID</th><th>반</th><th>세트</th>
            <th style="text-align:right;">총점</th><th>종료시각</th>
          </tr>
        </thead>
        <tbody id="sumTbody">
          <tr><td colspan="6">아직 종료된 세션 없음</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, query, where,
      onSnapshot, setDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCUhSD0-xxxxxxx",
      authDomain: "xxxx.firebaseapp.com",
      projectId: "xxxx",
      storageBucket: "xxxx.appspot.com",
      messagingSenderId: "xxxx",
      appId: "xxxx"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- 탭 전환 ---
    const tabs = {
      settings: document.getElementById("settings"),
      live: document.getElementById("live"),
      sum: document.getElementById("sum"),
    };
    function showTab(name) {
      Object.keys(tabs).forEach(k => tabs[k].style.display = (k===name?"block":"none"));
      document.querySelectorAll("nav button").forEach(btn=>btn.classList.remove("active"));
      document.getElementById("tab-"+name).classList.add("active");
    }
    document.getElementById("tab-settings").onclick = ()=>showTab("settings");
    document.getElementById("tab-live").onclick = ()=>showTab("live");
    document.getElementById("tab-sum").onclick = ()=>showTab("sum");

    // --- Firestore 구독 ---
    let currentClassId="", currentSetId="";

    function subscribeResults(classId, setId){
      const q = query(collection(db,"results"),
        where("classId","==",classId), where("set","==",setId));
      onSnapshot(q,(snap)=>{
        const rows=[];
        snap.forEach(doc=>rows.push(doc.data()));
        rows.sort((a,b)=>b.submittedAt?.seconds - a.submittedAt?.seconds);
        renderResults(rows);
      });
    }
    function renderResults(rows){
      const tb=document.getElementById("liveTbody");
      if(!rows.length){ tb.innerHTML="<tr><td colspan=8>결과 없음</td></tr>"; return; }
      tb.innerHTML=rows.map(r=>{
        const dt=r.submittedAt? new Date(r.submittedAt.seconds*1000).toLocaleString("ko-KR"):"-";
        return `<tr>
          <td>${r.name||"-"}</td><td>${r.sid||"-"}</td><td>${r.classId||"-"}</td>
          <td>${r.set||"-"}</td><td>${r.points||0}</td>
          <td>${r.correct||0}/${r.tries||0}</td>
          <td>${r.elapsed||"-"}</td><td>${dt}</td></tr>`;
      }).join("");
    }

    function subscribeSessionsForSum(classId,setId){
      const q=query(collection(db,"sessions"),
        where("classId","==",classId), where("set","==",setId));
      document.getElementById("sumMeta").textContent=`(${classId} · ${setId})`;
      onSnapshot(q,(snap)=>{
        const rows=[];
        snap.forEach(doc=>rows.push(doc.data()));
        rows.sort((a,b)=>{
          const pb=Number(b.totalPoints||0), pa=Number(a.totalPoints||0);
          if(pb!==pa) return pb-pa;
          return (b.finishedAt?.seconds||0)-(a.finishedAt?.seconds||0);
        });
        renderSessions(rows);
      });
    }
    function renderSessions(rows){
      const tb=document.getElementById("sumTbody");
      if(!rows.length){ tb.innerHTML="<tr><td colspan=6>종료된 세션 없음</td></tr>"; return; }
      tb.innerHTML=rows.map(r=>{
        const dt=r.finishedAt?new Date(r.finishedAt.seconds*1000).toLocaleString("ko-KR"):"-";
        return `<tr>
          <td>${r.name||"-"}</td><td>${r.sid||"-"}</td>
          <td>${r.classId||"-"}</td><td>${r.set||"-"}</td>
          <td style="text-align:right;font-weight:700;">${Number(r.totalPoints||0)}</td>
          <td>${dt}</td></tr>`;
      }).join("");
    }

    // --- 설정 저장/세션 제어 ---
    document.getElementById("saveBtn").onclick=async()=>{
      const classId=document.getElementById("classIdInput").value;
      const setId=document.getElementById("setInput").value;
      currentClassId=classId; currentSetId=setId;
      const words=document.getElementById("wordsInput").value.split(/\s+/).filter(Boolean);
      const config={
        classId,set:setId,words,
        rounds:+document.getElementById("roundsInput").value||5,
        speedBase:{
          fastMin:+document.getElementById("fastMinInput").value||420,
          fastMax:+document.getElementById("fastMaxInput").value||520,
          minFloor:+document.getElementById("minFloorInput").value||140
        },
        active:false
      };
      await setDoc(doc(db,"configs",`${classId}_${setId}`),config);
      alert("저장 완료");
      subscribeResults(classId,setId);
      subscribeSessionsForSum(classId,setId);
    };

    document.getElementById("startBtn").onclick=async()=>{
      if(!currentClassId||!currentSetId) return alert("먼저 저장하세요");
      await updateDoc(doc(db,"configs",`${currentClassId}_${currentSetId}`),{active:true});
    };
    document.getElementById("stopBtn").onclick=async()=>{
      if(!currentClassId||!currentSetId) return;
      await updateDoc(doc(db,"configs",`${currentClassId}_${currentSetId}`),{active:false});
    };

  </script>
</body>
</html>
