<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>교사 대시보드 – 실시간 결과</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif; }
    body { margin: 0; background:#f7f7fb; color:#222; }
    header { background:#2b67f6; color:#fff; padding:16px 20px; }
    header .sub { opacity:.9; font-size:14px; margin-top:4px }
    main { max-width: 1100px; margin: 20px auto; padding: 0 16px; }
    .card { background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04);}
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .pill { background:#eef3ff; color:#2b67f6; padding:6px 10px; border-radius:999px; font-weight:600; }
    .muted { color:#666; }
    .error { color:#b00020; font-weight:700; }
    .ok { color:#0a7f3f; font-weight:700; }
    table { width:100%; border-collapse: collapse; margin-top:12px; }
    th, td { border-bottom:1px solid #eee; padding:10px 8px; text-align:left; }
    th { font-size:13px; color:#555; background:#fafbff; position:sticky; top:0; }
    tbody tr:hover { background:#fafcff; }
    .right { text-align:right; }
    .small { font-size:12px; color:#666; }
    .flex { display:flex; gap:8px; align-items:center; }
    .badge { background:#f1f1f8; padding:2px 8px; border-radius:8px; font-size:12px; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin:8px 0 2px; }
    input[type="search"]{ padding:8px 10px; border:1px solid #dfe3ee; border-radius:10px; width:260px; }
    .hint { font-size:12px; color:#666; margin-top:6px; }
    .footer { margin-top:20px; font-size:12px; color:#777; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1 style="margin:0;">교사 대시보드</h1>
    </div>
    <div class="sub" id="headerMeta">파라미터 인식 중…</div>
  </header>

  <main>
    <div class="card">
      <div class="toolbar">
        <div class="flex">
          <span class="pill" id="statusPill">인증 대기</span>
          <span id="liveState" class="badge">실시간 구독 준비중</span>
        </div>
        <input type="search" id="searchBox" placeholder="이름·sid로 검색" />
      </div>
      <div id="notice" class="hint">
        URL 예시: <code>?classId=6-1&set=lesson1</code> — 두 값이 모두 있어야 정확히 필터링됩니다.
      </div>

      <table>
        <thead>
          <tr>
            <th>이름</th>
            <th>SID</th>
            <th>반</th>
            <th>세트</th>
            <th>점수</th>
            <th>정답/시도</th>
            <th>소요</th>
            <th>제출시각</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8" class="small">데이터를 불러오는 중…</td></tr>
        </tbody>
      </table>

      <div class="footer" id="footerInfo"></div>
    </div>
  </main>

  <script type="module">
    // --- 1) Firebase SDK (v9 모듈)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// --- 2) 프로젝트 설정 (※ 본인 값으로 교체하세요)
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID",
};


    // --- 3) 공통 유틸
    const $ = (sel) => document.querySelector(sel);
    const params = new URLSearchParams(location.search);
    const classId = params.get('classId') || '';
    const setId   = params.get('set') || '';

    $('#headerMeta').textContent = `classId=${classId || '(없음)'} · set=${setId || '(없음)'}  |  ${new Date().toLocaleString('ko-KR')}`;

    // --- 4) Firebase init
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    // --- 5) 전역 상태
    let unsub = null;
    let allRows = [];  // 스냅샷 원본 저장 → 검색/클라 정렬에 사용

    // --- 6) KST 시각 포맷
    const toKST = (date) => {
      if (!date) return '';
      try {
        return new Intl.DateTimeFormat('ko-KR', {
          dateStyle: 'short', timeStyle: 'medium', timeZone: 'Asia/Seoul'
        }).format(date);
      } catch { return date.toLocaleString('ko-KR'); }
    };

    // --- 7) createdAt 파싱(서버타임스탬프/ISO/Number 대응)
    const toDateSafe = (v) => {
      if (!v) return null;
      // Firestore Timestamp
      if (typeof v === 'object' && typeof v.seconds === 'number') {
        return new Date(v.seconds * 1000 + Math.floor((v.nanoseconds || 0)/1e6));
      }
      // ISO 문자열 또는 숫자(epoch ms)
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    };

    // --- 8) 테이블 렌더
    function renderTable() {
      const q = ($('#searchBox').value || '').trim().toLowerCase();

      // (A) setId는 클라이언트에서 최종 필터(인덱스 없이 우선 동작)
      let rows = allRows.filter(r => !setId || (r.set === setId));

      // (B) 검색어 필터 (이름/ sid)
      if (q) {
        rows = rows.filter(r => (r.name || '').toLowerCase().includes(q) || (r.sid || '').toLowerCase().includes(q));
      }

      // (C) 클라이언트 정렬: createdAt desc → 없으면 맨 뒤
      rows.sort((a, b) => {
        const ad = toDateSafe(a.createdAt);
        const bd = toDateSafe(b.createdAt);
        const at = ad ? ad.getTime() : -1;
        const bt = bd ? bd.getTime() : -1;
        return bt - at;
      });

      // 렌더
      const tbody = $('#tbody');
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="small">표시할 데이터가 없습니다.</td></tr>`;
        return;
      }

      const html = rows.map(r => {
        const d = toDateSafe(r.createdAt);
        let ratio = '';
        if (typeof r.correct === 'number' && typeof r.attempts === 'number') {
          ratio = `${r.correct}/${r.attempts}`;
        } else if (typeof r.attempts === 'number') {
          ratio = `-/${r.attempts}`;
        } else {
          ratio = '-';
        }
        const timeSpent = (typeof r.timeSpentSec === 'number') ? `${r.timeSpentSec}s` : (r.timeSpent || '');

        return `<tr>
          <td>${escapeHTML(r.name || '')}</td>
          <td>${escapeHTML(r.sid || '')}</td>
          <td>${escapeHTML(r.classId || '')}</td>
          <td>${escapeHTML(r.set || '')}</td>
          <td class="right">${(r.score ?? r.points ?? '')}</td>
          <td>${ratio}</td>
          <td>${escapeHTML(timeSpent)}</td>
          <td>${d ? toKST(d) : ''}</td>
        </tr>`;
      }).join('');
      tbody.innerHTML = html;

      $('#footerInfo').textContent = `표시: ${rows.length}건  (원본: ${allRows.length}건)`;
    }

    // XSS 방지용
    function escapeHTML(s) {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // --- 9) 실시간 구독 시작(인증 이후)
    async function startLive() {
      if (!classId) {
        $('#notice').innerHTML = `<span class="error">URL에 <code>classId</code>가 필요합니다.</span> 예: <code>?classId=6-1&set=lesson1</code>`;
        return;
      }

      // 인덱스 없이 우선 동작: 서버 쿼리는 classId 하나만 where, set은 클라 필터
      const col = collection(db, 'results');
      const qRef = query(col, where('classId', '==', classId));

      // 기존 구독 해제
      if (typeof unsub === 'function') unsub();

      $('#liveState').textContent = '실시간 구독 연결중…';

      unsub = onSnapshot(qRef, (snap) => {
        $('#liveState').textContent = '실시간 연결됨';
        const next = [];
        snap.forEach(doc => {
          const data = doc.data() || {};
          next.push({
            id: doc.id,
            classId: data.classId,
            set: data.set,
            sid: data.sid,
            name: data.name,
            score: data.score,
            points: data.points,
            correct: data.correct,
            attempts: data.attempts,
            timeSpent: data.timeSpent,
            timeSpentSec: data.timeSpentSec,
            createdAt: data.createdAt ?? data.submittedAt ?? data.timestamp ?? null, // 다양한 필드명 대응
          });
        });
        allRows = next;
        renderTable();
      }, (err) => {
        console.error(err);
        $('#liveState').textContent = '구독 오류';
        $('#notice').innerHTML = `<span class="error">실시간 구독 오류:</span> ${escapeHTML(err.message)}<br>
          <span class="hint">만약 <code>where('classId','==',…)</code> 외에 <code>where('set','==',…)</code>나 <code>orderBy('createdAt')</code>를 추가했다면, Firestore가 요청하는 인덱스를 생성해야 합니다(콘솔 에러의 링크 클릭).</span>`;
      });
    }

    // --- 10) 인증 가드: 익명 로그인 완료 후만 쿼리 실행
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        $('#statusPill').textContent = '익명 인증 진행중…';
        try {
          await signInAnonymously(auth);
          // 로그인 성공 시 onAuthStateChanged가 다시 호출됩니다.
        } catch (e) {
          console.error(e);
          $('#statusPill').textContent = '인증 실패';
          $('#notice').innerHTML = `<span class="error">익명 인증 실패:</span> ${escapeHTML(e.message)}`;
        }
        return;
      }
      $('#statusPill').textContent = '인증 완료';
      startLive(); // 인증됐으니 이제 쿼리/구독 시작
    });

    // --- 11) 검색 이벤트
    $('#searchBox').addEventListener('input', () => renderTable());
  </script>
</body>
</html>
