<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>교사 대시보드 – 실시간 결과 (minimal)</title>
  <style>
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif; background:#f7f7fb; color:#222; }
    header { background:#2b67f6; color:#fff; padding:16px 20px; }
    main { max-width:1100px; margin:20px auto; padding:0 16px; }
    .card { background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04);}
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th,td { border-bottom:1px solid #eee; padding:10px 8px; text-align:left; }
    th { font-size:13px; color:#555; background:#fafbff; position:sticky; top:0; }
    .pill { background:#eef3ff; color:#2b67f6; padding:6px 10px; border-radius:999px; font-weight:600; }
    .badge{ background:#f1f1f8; padding:2px 8px; border-radius:8px; font-size:12px; margin-left:8px;}
    .small{ font-size:12px; color:#666; }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0;">교사 대시보드</h1>
    <div id="meta" style="opacity:.9;font-size:14px;margin-top:4px"></div>
  </header>

  <main>
    <div class="card">
      <div><span class="pill" id="auth">인증 대기</span><span class="badge" id="live">실시간 구독 준비중</span></div>
      <table>
        <thead>
          <tr>
            <th>이름</th><th>SID</th><th>반</th><th>세트</th>
            <th>점수</th><th>정답/시도</th><th>소요</th><th>제출시각</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="8" class="small">데이터를 불러오는 중…</td></tr></tbody>
      </table>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ✅ 사용자님 프로젝트 설정 (반드시 이 값이어야 합니다)
    const firebaseConfig = {
      apiKey: "AIzaSyCUmSDDcFn45Z_ZH3UigbsothE6iD21C7Y",
      authDomain: "grade-6-english-c17f3.firebaseapp.com",
      projectId: "grade-6-english-c17f3",
      storageBucket: "grade-6-english-c17f3.appspot.com",
      messagingSenderId: "676305839050",
      appId: "1:676305839050:web:a5399633e7b828883fe533"
    };

    // 🔎 디버그: 실제 적용된 키 앞 12자 노출
    console.log('[teacher] apiKey =', (firebaseConfig.apiKey||'').slice(0,12)+'…');

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    const p = new URLSearchParams(location.search);
    const classId = p.get('classId')||'';
    const setId   = p.get('set')||'';
    document.getElementById('meta').textContent = `classId=${classId||'(없음)'} · set=${setId||'(없음)'}`;

    let unsub=null, all=[];
    const toDate=(v)=> v?.seconds?new Date(v.seconds*1000): (isNaN(new Date(v))?null:new Date(v));
    const toKST=(d)=> d?new Intl.DateTimeFormat('ko-KR',{dateStyle:'short',timeStyle:'medium',timeZone:'Asia/Seoul'}).format(d):'';

    function render(){
      const rows = all.filter(r=>!setId||r.set===setId).sort((a,b)=>(toDate(b.createdAt)?.getTime()||-1)-(toDate(a.createdAt)?.getTime()||-1));
      const tb = document.getElementById('tbody');
      if(!rows.length){ tb.innerHTML=`<tr><td colspan="8" class="small">표시할 데이터가 없습니다.</td></tr>`; return; }
      tb.innerHTML = rows.map(r=>{
        const d=toDate(r.createdAt);
        const ratio=(typeof r.correct==='number'&&typeof r.attempts==='number')?`${r.correct}/${r.attempts}`:'-';
        return `<tr>
          <td>${r.name||''}</td><td>${r.sid||''}</td><td>${r.classId||''}</td><td>${r.set||''}</td>
          <td>${r.score??r.points??''}</td><td>${ratio}</td><td>${r.timeSpent??(r.timeSpentSec?`${r.timeSpentSec}s`:'')}</td>
          <td>${toKST(d)}</td></tr>`;
      }).join('');
    }

    async function startLive(){
      if(!classId){ console.warn('classId 필요'); return; }
      if(unsub) unsub();
      const qRef = query(collection(db,'results'), where('classId','==',classId)); // 인덱스 없이 동작
      document.getElementById('live').textContent='실시간 구독 연결중…';
      unsub = onSnapshot(qRef, snap=>{
        const next=[];
        snap.forEach(doc=>{
          const d=doc.data()||{};
          next.push({ id:doc.id, ...d, createdAt:d.createdAt ?? d.submittedAt ?? d.timestamp ?? null });
        });
        all=next; render();
        document.getElementById('live').textContent='실시간 연결됨';
      },err=>{
        console.error(err); document.getElementById('live').textContent='구독 오류';
      });
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        document.getElementById('auth').textContent='익명 인증 중…';
        try{ await signInAnonymously(auth); }
        catch(e){ console.error(e); document.getElementById('auth').textContent='인증 실패'; }
        return;
      }
      document.getElementById('auth').textContent='인증 완료';
      startLive();
    });
  </script>
</body>
</html>
