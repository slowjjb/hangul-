<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì² ì ê²Œì„ â€“ í•™ìƒ í™”ë©´</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Malgun Gothic", sans-serif; }
    body { margin:0; background:#0f172a; color:#fff; }
    header { background:#1d4ed8; padding:12px 16px; }
    header .meta { opacity:.9; font-size:13px; margin-top:4px; }
    main { max-width:960px; margin:20px auto; padding:0 16px; }

    .hud { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { background:#172554; border:1px solid #334155; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; }
    .btn { border:1px solid #64748b; background:#111827; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.primary{ background:#2563eb; border-color:#2563eb; }
    .btn.warn{ background:#991b1b; border-color:#ef4444; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    /* íŠ¸ë™ */
    .track { position:relative; height:120px; margin:24px 0; border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    .guide { position:absolute; left:0; right:0; top:50%; height:1px; background:rgba(255,255,255,.1); }
    .word { position:absolute; top:50%; transform:translateY(-50%); font-size:42px; font-weight:800; letter-spacing:.06em; white-space:nowrap;
      text-shadow: 0 2px 6px rgba(0,0,0,.45);
    }

    .panel { background:#0b1220; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px; }

    /* ì…ë ¥ ëª¨ë‹¬ */
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); }
    .modal.open { display:flex; }
    .modal .box { width:min(500px, 92vw); background:#0b1220; border:1px solid #334155; border-radius:12px; padding:16px; }
    .row { display:flex; gap:8px; align-items:center; }
    input[type="text"]{ width:100%; padding:10px 12px; border:1px solid #334155; border-radius:10px; background:#0f172a; color:#fff; font-size:16px; }
    .muted { color:#93a4b5; font-size:12px; }

    .center { text-align:center; }
  </style>
</head>
<body>
  <header>
    <div><strong>ì² ì ê²Œì„</strong></div>
    <div id="headerMeta" class="meta">íŒŒë¼ë¯¸í„° ì¸ì‹ ì¤‘â€¦</div>
  </header>

  <main>
    <div class="hud">
      <span id="authPill" class="pill">ì¸ì¦ ëŒ€ê¸°</span>
      <span id="cfgPill" class="pill">ì„¤ì • ëŒ€ê¸°</span>
      <span class="pill">ì ìˆ˜ <span id="score">0</span></span>
      <span class="pill">ë¼ìš´ë“œ <span id="roundNow">0</span>/<span id="roundTotal">-</span></span>
      <span class="pill">ì†ë„ <span id="speedNow">-</span> px/s</span>
      <button id="btnAnswer" class="btn primary">ì •ë‹µ ì…ë ¥(Enter)</button>
      <button id="btnGiveUp" class="btn warn">í¬ê¸°(Esc)</button>
    </div>

    <div class="track panel">
      <div class="guide"></div>
      <div id="wordEl" class="word" style="left:-9999px">READY</div>
    </div>

    <div id="status" class="panel">
      <div id="message">êµì‚¬ê°€ ì„¸ì…˜ì„ ì‹œì‘í•˜ë©´ ìë™ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.</div>
      <div class="muted" style="margin-top:6px;">configs/{classId}_{set}ë¥¼ êµ¬ë…í•©ë‹ˆë‹¤.</div>
    </div>
  </main>

  <!-- ì…ë ¥ ëª¨ë‹¬ -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="box">
      <div style="font-weight:800; margin-bottom:8px;">ì •ë‹µ ì…ë ¥</div>
      <div class="row">
        <input id="answerInput" type="text" placeholder="ì² ìë¥¼ ì…ë ¥ í›„ Enter" autocomplete="off" />
        <button id="submitAnswer" class="btn primary">ì œì¶œ</button>
      </div>
      <div class="muted" style="margin-top:6px;">Enter ì œì¶œ Â· Esc ë‹«ê¸°</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, onSnapshot,
      collection, addDoc, serverTimestamp, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ğŸ”§ Firebase í”„ë¡œì íŠ¸ (ì‚¬ìš©ìë‹˜ ê°’)
    const firebaseConfig = {
      apiKey: "AIzaSyCUmSDDcFn45Z_ZH3UigbsothE6iD21C7Y",
      authDomain: "grade-6-english-c17f3.firebaseapp.com",
      projectId: "grade-6-english-c17f3",
      storageBucket: "grade-6-english-c17f3.appspot.com",
      messagingSenderId: "676305839050",
      appId: "1:676305839050:web:a5399633e7b828883fe533"
    };

    // ğŸŒ ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    // ğŸ§­ íŒŒë¼ë¯¸í„°
    const p = new URLSearchParams(location.search);
    const classId = p.get("classId") || "";
    const setId   = p.get("set") || "";
    const sid     = p.get("sid") || "";
    const name    = p.get("name") || "ì œì¶œì›";

    document.getElementById("headerMeta").textContent =
      "classId=" + (classId||"(ì—†ìŒ)") + " Â· set=" + (setId||"(ì—†ìŒ)") + " Â· sid=" + (sid||"(ì—†ìŒ)") + " Â· " + new Date().toLocaleString("ko-KR");

    // ğŸ§© ìƒíƒœ
    const wordEl = document.getElementById("wordEl");
    const scoreEl = document.getElementById("score");
    const roundNowEl = document.getElementById("roundNow");
    const roundTotalEl = document.getElementById("roundTotal");
    const speedNowEl = document.getElementById("speedNow");
    const statusEl = document.getElementById("status");
    const msgEl = document.getElementById("message");

    const modal = document.getElementById("modal");
    const input = document.getElementById("answerInput");

    const pointsSeq = [10,8,6,4,2];
    let user = null;

    // ê²Œì„ ëŸ°íƒ€ì„
    let words = [];
    let rounds = 0;
    let fastMin = 420, fastMax = 520, minFloor = 140;

    // í˜„ì¬ ë¬¸ì œ ìƒíƒœ
    let running = false;
    let curIndex = -1;       // ë¼ìš´ë“œ ì¸ë±ìŠ¤
    let curWord = "";
    let attemptIdx = 0;      // 0..4
    let dir = "L2R";         // 'L2R' | 'R2L'
    let speed = 0;           // px/s
    let totalScore = 0;
    let rafId = 0;           // animation frame id
    let startTs = 0;         // ms
    let posX = 0;            // px
    let trackW = 0;          // px

    function shuffle(arr){
      const a = arr.slice();
      for (let i=a.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function openModal(){
      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
      input.value = "";
      input.focus();
    }
    function closeModal(){
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
    }

    // ìµëª… ì¸ì¦ í›„ config êµ¬ë…
    onAuthStateChanged(auth, async (u)=>{
      if (!u){
        document.getElementById("authPill").textContent = "ìµëª… ì¸ì¦ ì¤‘â€¦";
        try { await signInAnonymously(auth); } catch(e){ console.error(e); document.getElementById("authPill").textContent = "ì¸ì¦ ì‹¤íŒ¨"; }
        return;
      }
      user = u;
      document.getElementById("authPill").textContent = "ì¸ì¦ ì™„ë£Œ";
      subscribeConfig();
    });

    function docId(){ return classId + "_" + setId; }

    function subscribeConfig(){
      if (!classId || !setId){
        msgEl.textContent = "URLì— classId, setì´ í•„ìš”í•©ë‹ˆë‹¤. ì˜ˆ) ?classId=6-1&set=lesson1&sid=01&name=ë¯¼ìˆ˜";
        return;
      }
      const ref = doc(db, "configs", docId());
      onSnapshot(ref, (snap)=>{
        if (!snap.exists()){
          document.getElementById("cfgPill").textContent = "ì„¤ì • ì—†ìŒ";
          msgEl.textContent = "êµì‚¬ê°€ configs/" + docId() + " ë¬¸ì„œë¥¼ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.";
          return;
        }
        const cfg = snap.data() || {};
        words = Array.isArray(cfg.words) ? cfg.words.filter(Boolean) : [];
        rounds = Math.max(1, Number(cfg.rounds || 1));
        const sp = cfg.speedBase || {};
        fastMin = Math.max(1, Number(sp.fastMin || 420));
        fastMax = Math.max(fastMin, Number(sp.fastMax || 520));
        minFloor= Math.max(1, Number(sp.minFloor || 140));
        roundTotalEl.textContent = String(rounds);

        document.getElementById("cfgPill").textContent = cfg.active ? "ì„¸ì…˜ í™œì„±" : "ì„¸ì…˜ ì¤‘ì§€";
        if (!cfg.active){
          stopAnim();
          running = false;
          msgEl.textContent = "ì„¸ì…˜ì´ ì¤‘ì§€ë¨. êµì‚¬ê°€ ì‹œì‘ì„ ëˆ„ë¥´ë©´ ì‹œì‘í•©ë‹ˆë‹¤.";
          wordEl.style.left = "-9999px";
          return;
        }

        // active=true ì´ê³ , ì§„í–‰ ì¤‘ì´ ì•„ë‹ˆë©´ ìŠ¤íƒ€íŠ¸
        if (!running){
          startSession();
        }
      }, (err)=>{
        console.error(err);
        document.getElementById("cfgPill").textContent = "ì„¤ì • ì˜¤ë¥˜";
      });
    }

    function startSession(){
      // ì¤€ë¹„
      totalScore = 0;
      scoreEl.textContent = "0";
      curIndex = -1;
      running = true;

      // ë‹¨ì–´ ì…”í”Œ í›„ roundsë§Œí¼ ìŠ¬ë¼ì´ìŠ¤(ë¶€ì¡±í•˜ë©´ ë°˜ë³µ)
      let pool = words.slice();
      if (pool.length === 0){ pool = ["start","ready","go"]; }
      pool = shuffle(pool);
      if (pool.length < rounds){
        const need = rounds - pool.length;
        // ë°˜ë³µ ì±„ìš°ê¸°
        for (let i=0;i<need;i++) pool.push(pool[i % pool.length]);
      } else {
        pool = pool.slice(0, rounds);
      }
      words = pool;

      msgEl.textContent = "ê²Œì„ ì‹œì‘!";
      nextProblem(true);
    }

    function nextProblem(newRound){
      if (newRound){
        curIndex++;
        roundNowEl.textContent = String(curIndex+1);
        if (curIndex >= rounds){
          endSession();
          return;
        }
        curWord = String(words[curIndex] || "");
        attemptIdx = 0;
        // ì´ˆê¸° ì†ë„: ë¹ ë¥¸ ë²”ìœ„ì—ì„œ ëœë¤
        speed = randRange(fastMin, fastMax);
      } else {
        // ê°™ì€ ë¬¸ì œ ì¬ì‹œì‘: ì†ë„ 10% ê°ì†Œ
        speed = Math.max(minFloor, speed * 0.9);
      }

      // ë°©í–¥ ëœë¤
      dir = Math.random() < 0.5 ? "L2R" : "R2L";
      speedNowEl.textContent = Math.round(speed);

      // ë°°ì¹˜
      const track = document.querySelector(".track");
      trackW = track.clientWidth;
      const textW = measureTextWidth(curWord, wordEl);
      if (dir === "L2R"){
        posX = -textW - 12;
      } else {
        posX = trackW + 12;
      }
      wordEl.textContent = curWord;
      wordEl.style.left = posX + "px";

      // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
      startAnim();
    }

    function startAnim(){
      stopAnim();
      startTs = performance.now();
      rafId = requestAnimationFrame(tick);
    }
    function stopAnim(){
      if (rafId){ cancelAnimationFrame(rafId); rafId = 0; }
    }
    function tick(ts){
      const dt = (ts - startTs) / 1000; // s
      startTs = ts;
      const delta = speed * dt; // px

      if (dir === "L2R"){
        posX += delta;
        wordEl.style.left = posX + "px";
        if (posX > trackW + 40){
          // íŠ¸ë™ ë°–ìœ¼ë¡œ ë‚˜ê°€ë„ ìë™ ì‹¤íŒ¨ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ (ìš”êµ¬ì‚¬í•­)
          // ê·¸ëƒ¥ ë‹¤ì‹œ ë°˜ëŒ€ìª½ìœ¼ë¡œ ì¬ë°°ì¹˜í•˜ë©´ ì‹œê°ì ìœ¼ë¡œ ëŠê¹€ â†’ ê·¸ëŒ€ë¡œ ë‘ 
          // í•„ìš” ì‹œ ì¬ë°°ì¹˜í•˜ë ¤ë©´ ì•„ë˜ 1ì¤„ ì£¼ì„ í•´ì œ
          // posX = -measureTextWidth(curWord, wordEl) - 12;
        }
      } else {
        posX -= delta;
        wordEl.style.left = posX + "px";
        if (posX < -measureTextWidth(curWord, wordEl) - 40){
          // ë™ì¼
          // posX = trackW + 12;
        }
      }
      rafId = requestAnimationFrame(tick);
    }

    function measureTextWidth(text, el){
      // ì„ì‹œë¡œ ì ìš©í•˜ì—¬ ëŒ€ëµ ê¸¸ì´ ê³„ì‚°
      el.style.visibility = "hidden";
      el.textContent = text;
      document.body.appendChild(el);
      const w = el.getBoundingClientRect().width || 100;
      el.style.visibility = "visible";
      return w;
    }

    function randRange(a,b){
      return a + Math.random()*(b-a);
    }

    // ì œì¶œ/í¬ê¸° ë²„íŠ¼
    document.getElementById("btnAnswer").addEventListener("click", ()=> openModal());
    document.getElementById("submitAnswer").addEventListener("click", submitAnswer);
    document.getElementById("btnGiveUp").addEventListener("click", ()=> handleWrongOrGiveUp(false));
    window.addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){
        if (modal.classList.contains("open")) submitAnswer();
        else openModal();
      } else if (e.key === "Escape"){
        if (modal.classList.contains("open")) closeModal();
        else handleWrongOrGiveUp(false);
      }
    });

    async function submitAnswer(){
      const val = (input.value || "").trim();
      if (!val) return;
      closeModal();
      const isCorrect = normalize(val) === normalize(curWord);
      if (isCorrect){
        const awarded = pointsSeq[Math.min(attemptIdx, pointsSeq.length-1)];
        totalScore += awarded;
        scoreEl.textContent = String(totalScore);
        await logResult({
          isCorrect:true, points:awarded
        });
        // ë‹¤ìŒ ë¼ìš´ë“œë¡œ
        nextProblem(true);
      } else {
        await handleWrongOrGiveUp(true);
      }
    }

    function normalize(s){
      return String(s).toLowerCase().replace(/\s+/g,"").trim();
    }

    async function handleWrongOrGiveUp(isWrong){
      // ì˜¤ë‹µ ë˜ëŠ” í¬ê¸° â†’ ê°™ì€ ë¬¸ì œ ì¬ì‹œë„, ì†ë„ 10% ê°ì†Œ
      await logResult({ isCorrect:false, points:0 });

      attemptIdx++;
      if (attemptIdx >= pointsSeq.length){
        // 2ì ì—ì„œë„ í‹€ë¦° ê²½ìš°: ì •ë‹µ ê³µê°œ í›„ ë‹¤ìŒ ë¬¸ì œ
        showReveal();
        // ì ê¹ ë©ˆì¶¤
        await waitMs(1000);
        nextProblem(true);
      } else {
        nextProblem(false);
      }
    }

    function showReveal(){
      msgEl.textContent = "ì •ë‹µ: " + curWord;
    }

    function waitMs(ms){ return new Promise(res=> setTimeout(res, ms)); }

    async function logResult({isCorrect, points}){
      try {
        await addDoc(collection(db, "results"), {
          classId, set: setId, sid, name,
          word: curWord,
          attemptIndex: attemptIdx,
          isCorrect: !!isCorrect,
          points: Number(points||0),
          speed: Math.round(speed),
          direction: dir,
          createdAt: serverTimestamp()
        });
      } catch (e){
        console.error("save result error", e);
      }
    }

    async function endSession(){
      running = false;
      stopAnim();
      wordEl.style.left = "-9999px";
      msgEl.textContent = "ì„¸íŠ¸ ì¢…ë£Œ! ì´ì : " + totalScore;

      try {
        await addSessionSummary();
      } catch (e){ console.error("session save error", e); }
    }

    async function addSessionSummary(){
      const refId = [classId,setId,sid,Date.now()].join("_");
      await setDoc(doc(db, "sessions", refId), {
        classId, set: setId, sid, name,
        totalPoints: totalScore,
        rounds,
        finishedAt: serverTimestamp()
      });
    }
  </script>
</body>
</html>
