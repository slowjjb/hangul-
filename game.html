<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì² ì ê²Œì„ â€“ í•™ìƒ í™”ë©´</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Malgun Gothic", sans-serif; }
    body { margin:0; background:#0f172a; color:#fff; }
    header { background:#1d4ed8; padding:12px 16px; }
    header .meta { opacity:.9; font-size:13px; margin-top:4px; }
    main { max-width:960px; margin:20px auto; padding:0 16px; }

    .hud { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { background:#172554; border:1px solid #334155; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; }
    .btn { border:1px solid #64748b; background:#111827; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.primary{ background:#2563eb; border-color:#2563eb; }
    .btn.warn{ background:#991b1b; border-color:#ef4444; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .track { position:relative; height:120px; margin:24px 0; border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    .guide { position:absolute; left:0; right:0; top:50%; height:1px; background:rgba(255,255,255,.1); }

    /* ê¸€ìë“¤ì€ ëª¨ë‘ ì—¬ê¸°(.word) ì•ˆì— ê°œë³„ spanìœ¼ë¡œ ë Œë”ë§ */
    .word { position:absolute; inset:0; pointer-events:none; }
    .ch {
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      font-size:42px; font-weight:800; letter-spacing:.06em; white-space:pre;
      text-shadow: 0 2px 6px rgba(0,0,0,.45);
      will-change: left, transform;
    }

    .panel { background:#0b1220; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px; }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); }
    .modal.open { display:flex; }
    .modal .box { width:min(500px, 92vw); background:#0b1220; border:1px solid #334155; border-radius:12px; padding:16px; }
    .row { display:flex; gap:8px; align-items:center; }
    input[type="text"]{ width:100%; padding:10px 12px; border:1px solid #334155; border-radius:10px; background:#0f172a; color:#fff; font-size:16px; }
    .muted { color:#93a4b5; font-size:12px; }
  </style>
</head>
<body>
  <header>
    <div><strong>ì² ì ê²Œì„</strong></div>
    <div id="headerMeta" class="meta">íŒŒë¼ë¯¸í„° ì¸ì‹ ì¤‘â€¦</div>
  </header>

  <main>
    <div class="hud">
      <span id="authPill" class="pill">ì¸ì¦ ëŒ€ê¸°</span>
      <span id="cfgPill" class="pill">ì„¤ì • ëŒ€ê¸°</span>
      <span class="pill">ì ìˆ˜ <span id="score">0</span></span>
      <span class="pill">ë¼ìš´ë“œ <span id="roundNow">0</span>/<span id="roundTotal">-</span></span>
      <span class="pill">ì†ë„ <span id="speedNow">-</span> px/s</span>
      <button id="btnAnswer" class="btn primary">ì •ë‹µ ì…ë ¥(Enter)</button>
      <button id="btnGiveUp" class="btn warn">í¬ê¸°(Esc)</button>
    </div>

    <div class="track panel" id="track">
      <div class="guide"></div>
      <div id="wordEl" class="word"></div>
    </div>

    <div id="status" class="panel">
      <div id="message">êµì‚¬ê°€ ì„¸ì…˜ì„ ì‹œì‘í•˜ë©´ ìë™ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.</div>
      <div class="muted" style="margin-top:6px;">configs/{classId}_{set}ë¥¼ êµ¬ë…í•©ë‹ˆë‹¤.</div>
    </div>
  </main>

  <!-- ì…ë ¥ ëª¨ë‹¬ -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="box">
      <div style="font-weight:800; margin-bottom:8px;">ì •ë‹µ ì…ë ¥</div>
      <div class="row">
        <input id="answerInput" type="text" placeholder="ì² ìë¥¼ ì…ë ¥ í›„ Enter" autocomplete="off" />
        <button id="submitAnswer" class="btn primary">ì œì¶œ</button>
      </div>
      <div class="muted" style="margin-top:6px;">Enter ì œì¶œ Â· Esc ë‹«ê¸°</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, onSnapshot,
      collection, addDoc, serverTimestamp, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase (ì‚¬ìš©ìë‹˜ í”„ë¡œì íŠ¸)
    const firebaseConfig = {
      apiKey: "AIzaSyCUmSDDcFn45Z_ZH3UigbsothE6iD21C7Y",
      authDomain: "grade-6-english-c17f3.firebaseapp.com",
      projectId: "grade-6-english-c17f3",
      storageBucket: "grade-6-english-c17f3.appspot.com",
      messagingSenderId: "676305839050",
      appId: "1:676305839050:web:a5399633e7b828883fe533"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    // URL íŒŒë¼ë¯¸í„°
    const p = new URLSearchParams(location.search);
    const classId = p.get("classId") || "";
    const setId   = p.get("set") || "";
    const sid     = p.get("sid") || "";
    const name    = p.get("name") || "ì œì¶œì›";
    document.getElementById("headerMeta").textContent =
      "classId=" + (classId||"(ì—†ìŒ)") + " Â· set=" + (setId||"(ì—†ìŒ)") + " Â· sid=" + (sid||"(ì—†ìŒ)") + " Â· " + new Date().toLocaleString("ko-KR");

    // DOM
    const track = document.getElementById("track");
    const wordEl = document.getElementById("wordEl");
    const scoreEl = document.getElementById("score");
    const roundNowEl = document.getElementById("roundNow");
    const roundTotalEl = document.getElementById("roundTotal");
    const speedNowEl = document.getElementById("speedNow");
    const msgEl = document.getElementById("message");
    const modal = document.getElementById("modal");
    const input = document.getElementById("answerInput");

    // ê·œì¹™
    const pointsSeq = [10,8,6,4,2];
    const GAP = 4;              // ê¸€ì ê°„ ê°„ê²©(px)
    const FONT_SIZE = 42;       // .chì™€ ë™ì¼
    const FONT_WEIGHT = 800;

    // ì„¤ì •/ëŸ°íƒ€ì„ ìƒíƒœ
    let words = [];
    let rounds = 0;
    let fastMin = 420, fastMax = 520, minFloor = 140;

    let user = null, running = false;
    let curIndex = -1, curWord = "", attemptIdx = 0;
    let dir = "L2R"; let speed = 0; let totalScore = 0;

    // ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ
    let rafId = 0, startTs = 0, headX = 0, trackW = 0;
    let chSpans = [], offsets = [], groupWidth = 0;

    // Canvas ì¸¡ì • ì¤€ë¹„
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    function refreshFont(){
      const fam = getComputedStyle(document.body).fontFamily || "system-ui";
      ctx.font = FONT_WEIGHT + " " + FONT_SIZE + "px " + fam;
    }
    refreshFont();

    // ì¸ì¦ í›„ config êµ¬ë…
    onAuthStateChanged(auth, async (u)=>{
      if (!u){
        setPill("authPill","ìµëª… ì¸ì¦ ì¤‘â€¦");
        try { await signInAnonymously(auth); } catch(e){ console.error(e); setPill("authPill","ì¸ì¦ ì‹¤íŒ¨"); }
        return;
      }
      user = u;
      setPill("authPill","ì¸ì¦ ì™„ë£Œ");
      subscribeConfig();
    });

    function setPill(id, t){ document.getElementById(id).textContent = t; }
    function docId(){ return classId + "_" + setId; }

    function subscribeConfig(){
      if (!classId || !setId){
        msgEl.textContent = "URLì— classId, setì´ í•„ìš”í•©ë‹ˆë‹¤. ì˜ˆ) ?classId=6-1&set=lesson1&sid=01&name=ë¯¼ìˆ˜";
        return;
      }
      onSnapshot(doc(db,"configs",docId()), (snap)=>{
        if (!snap.exists()){ setPill("cfgPill","ì„¤ì • ì—†ìŒ"); stopAnim(); clearLetters(); running=false; msgEl.textContent="êµì‚¬ ì„¤ì • ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤."; return; }
        const cfg = snap.data()||{};
        // ğŸ”’ ë‹¨ì–´ë¥¼ ì•ˆì „í•˜ê²Œ ì •ì œ(ë¹ˆ ì¤„/ê³µë°± ì œê±°)
        words = (Array.isArray(cfg.words)?cfg.words:[]).map(s=>String(s).trim()).filter(Boolean);
        // ğŸ”§ roundsëŠ” ë‹¨ì–´ ìˆ˜ë¥¼ ë„˜ì§€ ì•Šê²Œ ìë™ ë³´ì • (ë„˜ìœ¼ë©´ ì˜ë¼ëƒ„)
        const reqRounds = Math.max(1, Number(cfg.rounds||1));
        rounds = Math.min(reqRounds, Math.max(1, words.length));
        const sp=cfg.speedBase||{};
        fastMin = Math.max(1, Number(sp.fastMin||420));
        fastMax = Math.max(fastMin, Number(sp.fastMax||520));
        minFloor= Math.max(1, Number(sp.minFloor||140));
        roundTotalEl.textContent = String(rounds);

        setPill("cfgPill", cfg.active ? "ì„¸ì…˜ í™œì„±" : "ì„¸ì…˜ ì¤‘ì§€");

        if (!cfg.active){ stopAnim(); clearLetters(); running=false; msgEl.textContent="ì„¸ì…˜ì´ ì¤‘ì§€ë¨. ì‹œì‘ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘â€¦"; return; }
        if (!running) startSession();
      }, (err)=>{ console.error(err); setPill("cfgPill","ì„¤ì • ì˜¤ë¥˜"); });
    }

    function startSession(){
      totalScore=0; scoreEl.textContent="0";
      curIndex=-1; running=true;
      // ë‹¨ì–´ ì…”í”Œ â†’ roundsê°œë§Œ ì‚¬ìš© (ê¸°ë³¸ ë‹¨ì–´ ì„ì§€ ì•ŠìŒ)
      words = shuffle(words).slice(0, rounds);
      msgEl.textContent="ê²Œì„ ì‹œì‘!";
      nextProblem(true);
    }

    function nextProblem(newRound){
      if (newRound){
        curIndex++;
        if (curIndex>=rounds){ endSession(); return; }
        roundNowEl.textContent = String(curIndex+1);
        curWord = String(words[curIndex]||"");
        attemptIdx = 0;
        speed = rand(fastMin, fastMax);     // ë¹ ë¥´ê²Œ ì‹œì‘
      } else {
        speed = Math.max(minFloor, speed*0.9); // 10% ê°ì†
      }
      dir = Math.random()<0.5 ? "L2R" : "R2L";
      speedNowEl.textContent = Math.round(speed);

      buildLetters(curWord);                // â† ê¸€ì ë‹¨ìœ„ ë Œë”ë§
      trackW = track.clientWidth;
      headX = (dir==="L2R") ? -groupWidth-12 : trackW+groupWidth+12;

      startAnim();
    }

    // === ê¸€ì ë‹¨ìœ„ ë Œë”ë§ ===
function buildLetters(word){
  // 1) ì´ˆê¸°í™”
  clearLetters();

  // 2) ê¸€ì spanì„ ë¯¸ë¦¬ ìˆ¨ê¸´ ì±„ë¡œ DOMì— ë¶™ì—¬ 'ì‹¤ì œ ë Œë” í­'ì„ ì¸¡ì •
  chSpans = [];
  offsets = [];

  for (let i = 0; i < word.length; i++) {
    const ch = document.createElement("span");
    ch.className = "ch";
    ch.textContent = word[i];

    // ë³´ì´ì§€ ì•Šê²Œ ë¨¼ì € ë¶™ì—¬ í­ ì¸¡ì • ê°€ëŠ¥í•˜ê²Œ í•¨
    ch.style.visibility = "hidden";
    ch.style.left = "-99999px";

    wordEl.appendChild(ch);
    chSpans.push(ch);
  }

  // 3) ê°•ì œ ë¦¬í”Œë¡œìš° í›„ í­ ì¸¡ì • â†’ ëˆ„ì  ì˜¤í”„ì…‹ ê³„ì‚°
  let x = 0;
  for (let i = 0; i < chSpans.length; i++) {
    const w = Math.ceil(chSpans[i].getBoundingClientRect().width || 24);
    offsets.push(x);
    x += w + 4;     // ê¸€ì ê°„ê²© 4px (GAP)
  }
  groupWidth = Math.max(0, x - 4); // ë§ˆì§€ë§‰ ê°„ê²© ì œê±°

  // 4) ì‹œì‘ ìœ„ì¹˜ ì„¸íŒ…(ë°©í–¥ë³„) + ë³´ì´ë„ë¡ ì „í™˜
  const startFromLeft = (dir === "L2R");
  const trackWidth = track.clientWidth;

  for (let i = 0; i < chSpans.length; i++) {
    chSpans[i].style.visibility = "visible";
    const base = startFromLeft ? (-groupWidth - 12) : (trackWidth + groupWidth + 12);
    const xPos = startFromLeft ? (base + offsets[i]) : (base - offsets[i]);
    chSpans[i].style.left = xPos + "px";
  }
}

    function clearLetters(){ wordEl.innerHTML=""; chSpans=[]; offsets=[]; groupWidth=0; }

    // ì• ë‹ˆë©”ì´ì…˜
    function startAnim(){ stopAnim(); startTs=performance.now(); rafId=requestAnimationFrame(tick); }
    function stopAnim(){ if (rafId){ cancelAnimationFrame(rafId); rafId=0; } }
    function tick(t){
      const dt=(t-startTs)/1000; startTs=t;
      const d= speed*dt;

      if (dir==="L2R"){
        headX += d;
        for (let i=0;i<chSpans.length;i++) chSpans[i].style.left = (headX + offsets[i]) + "px";
      } else {
        headX -= d;
        for (let i=0;i<chSpans.length;i++) chSpans[i].style.left = (headX - offsets[i]) + "px";
      }
      rafId=requestAnimationFrame(tick);
    }

    // ì…ë ¥/íŒì •
    document.getElementById("btnAnswer").addEventListener("click", ()=> openModal());
    document.getElementById("submitAnswer").addEventListener("click", submitAnswer);
    document.getElementById("btnGiveUp").addEventListener("click", ()=> handleWrongOrGiveUp());
    window.addEventListener("keydown", (e)=>{
      if (e.key==="Enter"){ modal.classList.contains("open")?submitAnswer():openModal(); }
      else if (e.key==="Escape"){ modal.classList.contains("open")?closeModal():handleWrongOrGiveUp(); }
    });
    function openModal(){ modal.classList.add("open"); modal.setAttribute("aria-hidden","false"); input.value=""; input.focus(); }
    function closeModal(){ modal.classList.remove("open"); modal.setAttribute("aria-hidden","true"); }

    function normalize(s){ return String(s).toLowerCase().replace(/\s+/g,"").trim(); }
    function rand(a,b){ return a + Math.random()*(b-a); }
    function shuffle(a){ const x=a.slice(); for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]];} return x; }
    const sleep = ms=>new Promise(r=>setTimeout(r,ms));

    async function submitAnswer(){
      const val=(input.value||"").trim(); if (!val) return;
      closeModal();
      const ok = normalize(val)===normalize(curWord);
      if (ok){
        const pts = pointsSeq[Math.min(attemptIdx, pointsSeq.length-1)];
        totalScore += pts; scoreEl.textContent=String(totalScore);
        await log({isCorrect:true, points:pts});
        nextProblem(true);
      } else {
        await handleWrongOrGiveUp();
      }
    }
    async function handleWrongOrGiveUp(){
      await log({isCorrect:false, points:0});
      attemptIdx++;
      if (attemptIdx >= pointsSeq.length){
        msgEl.textContent = "ì •ë‹µ: " + curWord;
        await sleep(900);
        nextProblem(true);
      } else {
        nextProblem(false); // ê°™ì€ ë¬¸ì œ, ê°ì†
      }
    }

    // ì €ì¥
    async function log({isCorrect, points}){
      try{
        await addDoc(collection(db,"results"), {
          classId, set:setId, sid, name,
          word: curWord,
          attemptIndex: attemptIdx,
          isCorrect: !!isCorrect,
          points: Number(points||0),
          speed: Math.round(speed),
          direction: dir,
          createdAt: serverTimestamp()
        });
      }catch(e){ console.error("save result error", e); }
    }

    async function endSession(){
      running=false; stopAnim(); clearLetters();
      msgEl.textContent = "ì„¸íŠ¸ ì¢…ë£Œ! ì´ì : " + totalScore;
      try{
        await setDoc(doc(db,"sessions",[classId,setId,sid,Date.now()].join("_")), {
          classId, set:setId, sid, name,
          totalPoints: totalScore,
          rounds,
          finishedAt: serverTimestamp()
        });
      }catch(e){ console.error("session save error", e); }
    }
  </script>
</body>
</html>
