<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>철자 게임 – 학생 화면</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Malgun Gothic", sans-serif; }
    body { margin:0; background:#0f172a; color:#fff; }
    header { background:#1d4ed8; padding:12px 16px; }
    header .meta { opacity:.9; font-size:13px; margin-top:4px; }
    main { max-width:1280px; margin:20px auto; padding:0 16px; }

    .hud { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { background:#172554; border:1px solid #334155; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; }
    .btn { border:1px solid #64748b; background:#111827; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.primary{ background:#2563eb; border-color:#2563eb; }
    .btn.warn{ background:#991b1b; border-color:#ef4444; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .track { position:relative; height:420px; margin:24px 0;
             border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
             border:1px solid rgba(255,255,255,.08); overflow:hidden; }
    .guide { position:absolute; left:0; right:0; top:50%; height:1px; background:rgba(255,255,255,.08); }
    .word { position:relative; height:100%; pointer-events:none; }
    .ch { position:absolute; transform:translateY(-50%); font-size:56px; font-weight:800; letter-spacing:.06em; white-space:pre;
          text-shadow:0 2px 6px rgba(0,0,0,.45); will-change:left, top; }

    .panel { background:#0b1220; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px; }
    .muted { color:#93a4b5; font-size:12px; }

    /* 배너/모달 레이어 우선순위: 배너 50, 모달 60 */
    .banner-wrap { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:50; }
    .banner-wrap.open { display:flex; }
    .banner { min-width:320px; max-width:90vw; text-align:center; color:#fff; font-weight:900; font-size:24px; padding:18px 26px;
              border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.15); }
    .banner.ok { background:#1e40af; }
    .banner.no { background:#991b1b; }

    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:60; }
    .modal.open { display:flex; }
    .modal .box { width:min(520px, 92vw); background:#0b1220; border:1px solid #334155; border-radius:12px; padding:16px; }
    .row { display:flex; gap:8px; align-items:center; }
    input[type="text"]{ width:100%; padding:10px 12px; border:1px solid #334155; border-radius:10px; background:#0f172a; color:#fff; font-size:16px; }
  </style>
</head>
<body>
  <header>
    <div><strong>철자 게임</strong></div>
    <div id="headerMeta" class="meta">파라미터 인식 중…</div>
  </header>

  <main>
    <div class="hud">
      <span id="authPill" class="pill">인증 대기</span>
      <span id="cfgPill" class="pill">설정 대기</span>
      <span class="pill">점수 <span id="score">0</span></span>
      <span class="pill">라운드 <span id="roundNow">0</span>/<span id="roundTotal">-</span></span>
      <span class="pill">평균 속도 <span id="speedNow">-</span> px/s</span>
      <button id="btnAnswer" class="btn primary">정답 입력(Enter)</button>
      <button id="btnGiveUp" class="btn warn">포기(Esc)</button>
      <a class="btn" href="join.html">처음으로</a>
    </div>

    <div class="track panel" id="track">
      <div class="guide"></div>
      <div id="wordEl" class="word"></div>
    </div>

    <div id="status" class="panel">
      <div id="message">교사가 세션을 시작하면 자동으로 시작합니다.</div>
      <div class="muted" style="margin-top:6px;">configs/{classId}_{set}를 구독합니다.</div>
    </div>
  </main>

  <!-- 배너 -->
  <div id="bannerWrap" class="banner-wrap" aria-hidden="true">
    <div id="banner" class="banner">정답입니다!</div>
  </div>

  <!-- 모달 -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="box">
      <div style="font-weight:800; margin-bottom:8px;">정답 입력</div>
      <div class="row">
        <input id="answerInput" type="text" placeholder="철자를 입력 후 Enter" autocomplete="off" />
        <button id="submitAnswer" class="btn primary">제출</button>
      </div>
      <div class="muted" style="margin-top:6px;">Enter 제출 · Esc 닫기</div>
    </div>
  </div>

  <!-- 로드 실패 안내 -->
  <script>
    (function () {
      const p = new URLSearchParams(location.search);
      document.getElementById('headerMeta').textContent =
        `classId=${p.get('classId')||'(없음)'} · set=${p.get('set')||'(없음)'} · sid=${p.get('sid')||'(없음)'} · ${new Date().toLocaleString('ko-KR')}`;
      setTimeout(() => {
        if (!window.firebaseReady) {
          document.getElementById('authPill').textContent = '로딩 실패';
          document.getElementById('cfgPill').textContent = '네트워크/차단 확인';
          document.getElementById('message').textContent =
            'Firebase 로드에 실패했습니다. Ctrl+F5 또는 시크릿 창으로 열어보거나, 광고차단/보안 확장프로그램을 잠시 꺼주세요.';
        }
      }, 2500);
    })();
  </script>

  <!-- 앱 코드 -->
  <script type="module">
  (async () => {
    window.firebaseReady = false;
    const setPill = (id, t) => { const el=document.getElementById(id); if(el) el.textContent=t; };

    // Firebase 동적 import (gstatic → esm.sh 폴백)
    async function loadFrom(label, urls){
      try { const mods = await Promise.all(urls.map(u => import(u))); return { ok:true, mods }; }
      catch(e){ console.warn(`[firebase] ${label} failed`, e); return { ok:false, error:e }; }
    }
    let res = await loadFrom('gstatic', [
      'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js',
      'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js',
      'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js',
    ]);
    if (!res.ok) {
      res = await loadFrom('esm.sh', [
        'https://esm.sh/firebase@10.12.2/app?target=es2022',
        'https://esm.sh/firebase@10.12.2/firestore?target=es2022',
        'https://esm.sh/firebase@10.12.2/auth?target=es2022',
      ]);
      if (!res.ok) throw res.error || new Error('Firebase import failed');
    }
    const [appMod, fsMod, authMod] = res.mods;
    const { initializeApp } = appMod;
    const { getFirestore, doc, onSnapshot, collection, addDoc, serverTimestamp, setDoc } = fsMod;
    const { getAuth, onAuthStateChanged, signInAnonymously } = authMod;

    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyCUmSDDcFn45Z_ZH3UigbsothE6iD21C7Y",
      authDomain: "grade-6-english-c17f3.firebaseapp.com",
      projectId: "grade-6-english-c17f3",
      storageBucket: "grade-6-english-c17f3.appspot.com",
      messagingSenderId: "676305839050",
      appId: "1:676305839050:web:a5399633e7b828883fe533"
    };
    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);
    window.firebaseReady = true;

    // URL/DOM
    const p = new URLSearchParams(location.search);
    const classId = p.get("classId") || "";
    const setId   = p.get("set") || "";
    const sid     = p.get("sid") || "";
    const name    = p.get("name") || "제출원";

    const track = document.getElementById("track");
    const wordEl = document.getElementById("wordEl");
    const scoreEl = document.getElementById("score");
    const roundNowEl = document.getElementById("roundNow");
    const roundTotalEl = document.getElementById("roundTotal");
    const speedNowEl = document.getElementById("speedNow");
    const msgEl = document.getElementById("message");
    const modal = document.getElementById("modal");
    const input = document.getElementById("answerInput");
    const bannerWrap = document.getElementById("bannerWrap");
    const banner = document.getElementById("banner");

    // 규칙/상수
    const pointsSeq = [10,8,6,4,2];
    const OUT_MARGIN = 420, TOP_PADDING = 36, START_JITTER = 0.45;
    const NEXT_DELAY_MS = 2000;

    // 상태
    let words = [];
    let rounds = 0;
    let fastMin = 420, fastMax = 520, minFloor = 140;

    // ⬇️ runId(이번 판 식별자): 문자열로 사용
    let runId = "";
    let lastRunId = null;

    let user = null, running = false;
    let curIndex = -1, curWord = "", attemptIdx = 0;
    let totalScore = 0;
    let speedScale = 1.0;

    let letters = []; let rafId = 0; let startTs = 0;

    // 진행에 쓰는 플레이리스트(중복 허용)
    let gameList = [];

    function updateHeaderMeta(){
      document.getElementById("headerMeta").textContent =
        `classId=${classId||"(없음)"} · set=${setId||"(없음)"} · sid=${sid||"(없음)"} · run=${runId||"-"} · ${new Date().toLocaleString("ko-KR")}`;
    }
    updateHeaderMeta();

    // 자모 분해 / 문자 분해
    function decomposeToJamo(str){
      const CHO  = ["ㄱ","ㄲ","ㄴ","ㄷ","ㄸ","ㄹ","ㅁ","ㅂ","ㅃ","ㅅ","ㅆ","ㅇ","ㅈ","ㅉ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];
      const JUNG = ["ㅏ","ㅐ","ㅑ","ㅒ","ㅓ","ㅔ","ㅕ","ㅖ","ㅗ","ㅘ","ㅙ","ㅚ","ㅛ","ㅜ","ㅝ","ㅞ","ㅟ","ㅠ","ㅡ","ㅢ","ㅣ"];
      const JONG = ["","ㄱ","ㄲ","ㄳ","ㄴ","ㄵ","ㄶ","ㄷ","ㄹ","ㄺ","ㄻ","ㄼ","ㄽ","ㄾ","ㄿ","ㅀ","ㅁ","ㅂ","ㅄ","ㅅ","ㅆ","ㅇ","ㅈ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];
      const base=0xAC00, last=0xD7A3, out=[];
      for(const ch of str){
        const code = ch.codePointAt(0);
        if(code>=base && code<=last){
          const S = code - base;
          const cho  = Math.floor(S/(21*28));
          const jung = Math.floor((S%(21*28))/28);
          const jong = S%28;
          out.push(CHO[cho], JUNG[jung]); if(jong) out.push(JONG[jong]);
        } else out.push(ch);
      }
      return out;
    }
    function toPieces(word){
      const s = String(word||"").replace(/\s+/g,"");
      if(!s) return [];
      return /[가-힣]/.test(s) ? decomposeToJamo(s) : Array.from(s);
    }

    function buildPlaylist(srcWords, n){
      const pool = (srcWords||[]).map(s=>String(s).trim()).filter(Boolean);
      if (pool.length===0 || n<=0) return [];
      const arr = [];
      while (arr.length < n){
        arr.push(pool[Math.floor(Math.random()*pool.length)]);
      }
      return shuffle(arr);
    }

    // 인증 → 설정 구독
    onAuthStateChanged(auth, async (u)=>{
      if (!u){
        setPill("authPill","익명 인증 중…");
        try { await signInAnonymously(auth); } catch(e){ console.error(e); setPill("authPill","인증 실패"); }
        return;
      }
      user = u;
      setPill("authPill","인증 완료");
      subscribeConfig();
    });

    function cfgDocId(){ return `${classId}_${setId}`; }
    function subscribeConfig(){
      if (!classId || !setId){
        msgEl.textContent = "URL에 classId, set이 필요합니다. 예) ?classId=6-1&set=lesson1&sid=01&name=민수";
        return;
      }
      onSnapshot(doc(db,"configs",cfgDocId()), (snap)=>{
        if (!snap.exists()){
          setPill("cfgPill","설정 없음");
          stopAnim(); clearLetters(); running=false;
          msgEl.textContent="교사 설정 문서가 없습니다."; return;
        }
        const cfg = snap.data()||{};

        // ⬇️ runId(문자열) 갱신
        runId = String(cfg.runId || "");
        updateHeaderMeta();

        words = (Array.isArray(cfg.words)?cfg.words:[]).map(s=>String(s).trim()).filter(Boolean);

        const reqRounds = Math.max(1, Number(cfg.rounds||1));
        rounds = reqRounds;
        roundTotalEl.textContent = String(rounds);

        const sp=cfg.speedBase||{};
        fastMin = Math.max(160, Number(sp.fastMin||420));
        fastMax = Math.max(fastMin, Number(sp.fastMax||520));
        minFloor= Math.max(120, Number(sp.minFloor||140));

        setPill("cfgPill", cfg.active ? "세션 활성" : "세션 중지");

        // active & runId가 있어야 시작
        if (!cfg.active || !runId){
          stopAnim(); clearLetters(); running=false;
          msgEl.textContent = !cfg.active ? "세션이 중지됨. 시작을 기다리는 중…" : "runId가 아직 없습니다. 교사가 [세션 시작] 또는 [새 판]을 눌러주세요.";
          return;
        }

        // 처음 시작이거나 runId가 바뀌면 리셋 후 시작
        if (!running || lastRunId !== runId){
          startSession();
          lastRunId = runId;
        }
      }, (err)=>{ console.error(err); setPill("cfgPill","설정 오류"); });
    }

    // 세션 진행
    function startSession(){
      stopAnim(); clearLetters();

      totalScore = 0; scoreEl.textContent = "0";
      curIndex = -1; attemptIdx = 0; speedScale = 1.0;
      running = true;

      gameList = buildPlaylist(words, rounds);
      if (gameList.length === 0){
        msgEl.textContent = "단어 목록이 비어 있습니다.";
        running = false; return;
      }
      msgEl.textContent = "게임 시작!";
      nextProblem(true);
    }

    function nextProblem(newRound){
      if (newRound){
        curIndex++;
        if (curIndex >= rounds){ endSession(); return; }
        roundNowEl.textContent = String(curIndex+1);
        curWord = String(gameList[curIndex] || "");
        attemptIdx = 0;
        speedScale = 1.0;
      } else {
        // 같은 문제 재시작: 속도 10% 감속(바닥 보장)
        speedScale = Math.max(minFloor / fastMax, speedScale * 0.9);
      }
      buildLetters(curWord);
      startAnim();
    }

    function buildLetters(word){
      clearLetters(); letters = [];
      const H = track.clientHeight;

      // 조각 0개 방지: 원문 1조각으로 대체
      let pieces = toPieces(word);
      if (pieces.length === 0) pieces = [String(word||'')];

      for (let i=0; i<pieces.length; i++){
        const el = document.createElement("span");
        el.className = "ch";
        el.textContent = pieces[i];
        const top = rand(TOP_PADDING, H - TOP_PADDING);
        el.style.top = top + "px";
        el.style.left = "-99999px";
        wordEl.appendChild(el);

        const side = Math.random() < 0.5 ? "L" : "R";
        const baseSpeed = rand(fastMin, fastMax);
        const speed = Math.max(minFloor, baseSpeed * speedScale);
        const startTime = Math.random() * START_JITTER;
        letters.push({ el, side, speed, startTime, top });
      }
      const avg = Math.round(letters.reduce((s,l)=>s+l.speed,0)/Math.max(1,letters.length));
      speedNowEl.textContent = `${avg}`;
      startTs = performance.now();
    }

    function clearLetters(){ wordEl.innerHTML=""; letters=[]; }
    function startAnim(){ stopAnim(); rafId=requestAnimationFrame(tick); }
    function stopAnim(){ if (rafId){ cancelAnimationFrame(rafId); rafId=0; } }

    function tick(now){
      const elapsed = (now - startTs)/1000;
      const W = track.clientWidth;
      let doneCount = 0;
      for (const L of letters){
        const t = elapsed - L.startTime;
        if (t <= 0){
          L.el.style.left = (L.side==="L" ? -OUT_MARGIN : (W + OUT_MARGIN)) + "px";
          continue;
        }
        const d = L.speed * t;
        let x;
        if (L.side === "L"){
          x = -OUT_MARGIN + d;
          if (x > W + OUT_MARGIN){ doneCount++; continue; }
        } else {
          x = W + OUT_MARGIN - d;
          if (x < -OUT_MARGIN){ doneCount++; continue; }
        }
        L.el.style.left = x + "px";
      }
      if (doneCount >= letters.length){ stopAnim(); return; } // 자동 진행 없음
      rafId = requestAnimationFrame(tick);
    }

    // 입력/판정
    document.getElementById("btnAnswer").addEventListener("click", ()=> openModal());
    document.getElementById("submitAnswer").addEventListener("click", submitAnswer);
    document.getElementById("btnGiveUp").addEventListener("click", ()=> handleWrongOrGiveUp());
    window.addEventListener("keydown", (e)=>{
      if (e.key==="Enter"){ modal.classList.contains("open")?submitAnswer():openModal(); }
      else if (e.key==="Escape"){ modal.classList.contains("open")?closeModal():handleWrongOrGiveUp(); }
    });

    function openModal(){
      // 배너가 클릭을 가로막는 경우가 있어서 먼저 닫음
      bannerWrap.classList.remove("open");
      bannerWrap.setAttribute("aria-hidden","true");

      modal.classList.add("open");
      modal.setAttribute("aria-hidden","false");
      input.value="";
      input.focus();
    }
    function closeModal(){ modal.classList.remove("open"); modal.setAttribute("aria-hidden","true"); }
    function normalize(s){ return String(s).toLowerCase().replace(/\s+/g,"").trim(); }

    function showBanner(ok, text){
      banner.className = "banner " + (ok? "ok" : "no");
      banner.textContent = text;
      bannerWrap.classList.add("open");
      bannerWrap.setAttribute("aria-hidden","false");
    }
    function hideBanner(){
      bannerWrap.classList.remove("open");
      bannerWrap.setAttribute("aria-hidden","true");
    }

    async function submitAnswer(){
      const val=(input.value||"").trim(); if (!val) return;
      closeModal();
      const ok = normalize(val)===normalize(curWord);
      if (ok){
        const pts = pointsSeq[Math.min(attemptIdx, pointsSeq.length-1)];
        totalScore += pts; scoreEl.textContent=String(totalScore);
        await log({isCorrect:true, points:pts});
        showBanner(true, "정답입니다!");
        await sleep(NEXT_DELAY_MS);
        hideBanner();
        nextProblem(true);
      } else {
        await handleWrongOrGiveUp();
      }
    }

    async function handleWrongOrGiveUp(){
      await log({isCorrect:false, points:0});
      attemptIdx++;
      if (attemptIdx >= pointsSeq.length){
        showBanner(false, `틀렸습니다. 정답: ${curWord}`);
        await sleep(NEXT_DELAY_MS);
        hideBanner();
        nextProblem(true);
      } else {
        showBanner(false, "틀렸습니다!");
        await sleep(NEXT_DELAY_MS);
        hideBanner();
        nextProblem(false);   // 같은 문제 10% 느리게
      }
    }

    // 저장/종료
    async function log({isCorrect, points}){
      try{
        await addDoc(collection(db,"results"), {
          classId, set:setId, sid, name,
          runId,                             // ← 이번 판 식별자
          word: curWord,
          attemptIndex: attemptIdx,
          isCorrect: !!isCorrect,
          points: Number(points||0),
          avgSpeed: Math.round(letters.reduce((s,l)=>s+l.speed,0)/Math.max(1,letters.length)),
          createdAt: serverTimestamp()
        });
      }catch(e){ console.error("save result error", e); }
    }
    async function endSession(){
      running=false; stopAnim(); clearLetters();
      showBanner(true, `세트 종료! 총점: ${totalScore}`);
      await sleep(1500);
      hideBanner();
      msgEl.textContent = "세트 종료! 총점: " + totalScore;
      try{
        await setDoc(doc(db,"sessions",[classId,setId,sid,Date.now()].join("_")), {
          classId, set:setId, sid, name,
          runId,                             // ← 세션에도 기록
          totalPoints: totalScore,
          rounds,
          finishedAt: serverTimestamp()
        });
      }catch(e){ console.error("session save error", e); }
    }

    // 유틸
    function rand(a,b){ return a + Math.random()*(b-a); }
    function shuffle(a){
      const x = a.slice();
      for (let i = x.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [x[i], x[j]] = [x[j], x[i]];
      }
      return x;
    }
    const sleep = ms=>new Promise(r=>setTimeout(r,ms));

  })().catch(e=>{
    console.error(e);
    document.getElementById('authPill').textContent='로딩 실패';
    document.getElementById('cfgPill').textContent='네트워크/차단 확인';
    document.getElementById('message').textContent='Firebase 모듈을 로드하지 못했습니다. 시크릿 창/다른 네트워크/확장 OFF 후 재시도하세요.';
  });
  </script>
</body>
</html>
