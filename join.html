<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>철자 게임 입장</title>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
  <style>
    :root{font-family:'Gowun Dodum','Noto Sans KR',sans-serif;}
    html,body{height:100%;margin:0;background:#0f172a;color:#fff;}
    .wrap{max-width:560px;margin:0 auto;padding:24px;}
    h1{font-size:24px;margin:18px 0 10px}
    .card{background:#0b1220;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;}
    label{display:block;margin:10px 0 6px;font-weight:700}
    input,select{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#fff;font-size:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{width:100%;padding:12px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:800}
    .btn.primary{background:#2563eb;color:#fff}
    .muted{color:#93a4b5;font-size:13px;margin-top:8px}
    .note{font-size:13px;color:#a5b4fc}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, query, where, getDocs, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ★ 프로젝트 값
    const firebaseConfig = {
      apiKey: "AIzaSyCUmSDDcFn45Z_ZH3UigbsothE6iD21C7Y",
      authDomain: "grade-6-english-c17f3.firebaseapp.com",
      projectId: "grade-6-english-c17f3",
      storageBucket: "grade-6-english-c17f3.appspot.com",
      messagingSenderId: "676305839050",
      appId: "1:676305839050:web:a5399633e7b828883fe533"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    // 게임 라우팅 매핑 (configs.game 값 -> 파일명)
    const GAME_ROUTES = {
      letters: "game.html",      // 기본 철자 게임
      // 예: 다른 게임 추가 시
      // wordfall: "wordfall.html",
    };

    const $ = (id)=>document.getElementById(id);
    const sp = new URLSearchParams(location.search);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        try { await signInAnonymously(auth); }
        catch (e) { console.error(e); alert("인증 실패: " + e.message); }
        return;
      }
      // 인증 후 초기화
      init();
    });

    function init(){
      const grade   = $("grade");
      const classNo = $("classNo");
      const setSel  = $("set");
      const sid     = $("sid");
      const name    = $("name");
      const goBtn   = $("goBtn");
      const setNote = $("setNote");

      // URL 또는 저장값 기본 채우기
      grade.value   = sp.get("grade") || localStorage.getItem("grade") || "6";
      classNo.value = localStorage.getItem("classNo") || "1";
      sid.value     = localStorage.getItem("sid") || "";
      name.value    = localStorage.getItem("name") || "";

      // classId 계산 함수(표시는 안 함)
      const getClassId = ()=> `${grade.value}-${classNo.value}`;

      // 반/학년 바뀌면 세트 목록 다시 로드
      grade.addEventListener("change", loadSets);
      classNo.addEventListener("change", loadSets);

      async function loadSets(){
        // 로딩 표시
        setSel.innerHTML = `<option value="" disabled selected>세트 목록 불러오는 중…</option>`;
        setNote.textContent = "";

        const classId = getClassId();
        try {
          const qy = query(collection(db,"configs"), where("classId","==",classId));
          const snap = await getDocs(qy);

          const map = new Map(); // set -> game
          snap.forEach(d=>{
            const data = d.data()||{};
            if (data.set) map.set(data.set, data.game || "letters");
          });

          setSel.innerHTML = "";
          if (map.size === 0) {
            setSel.innerHTML = `<option value="" disabled selected>해당 반의 세트가 없습니다</option>`;
            setNote.textContent = "교사 페이지에서 설정을 저장하면 목록에 나타납니다.";
            return;
          }

          for (const [setName, game] of map.entries()) {
            const opt = document.createElement("option");
            opt.value = setName;
            opt.textContent = `${setName}${game && game!=="letters" ? ` (${game})` : ""}`;
            setSel.appendChild(opt);
          }

          // 저장된 set 값이 있으면 기본 선택
          const savedSet = localStorage.getItem("set");
          if (savedSet && map.has(savedSet)) setSel.value = savedSet;
          else setSel.selectedIndex = 0;

        } catch (err) {
          console.error("세트 로드 실패", err);
          setSel.innerHTML = `<option value="" disabled selected>세트 목록을 읽을 수 없습니다</option>`;
          setNote.textContent = "네트워크/권한 문제일 수 있어요. 잠시 후 다시 시도하세요.";
        }
      }

      // 최초 한 번 로드
      loadSets();

      // 시작 버튼
      goBtn.addEventListener("click", async ()=>{
        const classId = getClassId();
        const set     = setSel.value || "";
        const sidV    = sid.value.trim();
        const nameV   = name.value.trim();

        if (!set)   return alert("세트를 선택하세요.");
        if (!sidV)  return alert("번호(sid)를 입력하세요. 예: 01");
        if (!nameV) return alert("이름을 입력하세요.");

        // 저장(다음 접속 때 자동 채움)
        localStorage.setItem("grade",  grade.value);
        localStorage.setItem("classNo",classNo.value);
        localStorage.setItem("classId",classId);
        localStorage.setItem("set",    set);
        localStorage.setItem("sid",    sidV);
        localStorage.setItem("name",   nameV);

        // 선택 세트의 game 타입 확인 후 라우팅
        let route = "game.html";
        try {
          const ref = doc(db, "configs", `${classId}_${set}`);
          const snap = await getDoc(ref);
          const cfg = snap.exists() ? (snap.data()||{}) : {};
          const gameKey = (cfg.game || "letters").toString();
          route = GAME_ROUTES[gameKey] || "game.html";
        } catch (e) {
          console.warn("라우팅용 config 로드 실패", e);
        }

        const q = new URLSearchParams({ classId, set, sid: sidV, name: nameV });
        location.href = `${route}?${q.toString()}`;
      });

      // Enter 키로도 입장
      ["sid","name"].forEach(id=>{
        $(id).addEventListener("keydown", e=>{
          if(e.key==="Enter") $("goBtn").click();
        });
      });
    }
  </script>
</head>
<body>
  <div class="wrap">
    <h1>철자 게임 입장</h1>
    <div class="card">
      <div class="row">
        <div>
          <label for="grade">학년</label>
          <select id="grade">
            <option value="1">1학년</option>
            <option value="2">2학년</option>
            <option value="3">3학년</option>
            <option value="4">4학년</option>
            <option value="5">5학년</option>
            <option value="6" selected>6학년</option>
          </select>
        </div>
        <div>
          <label for="classNo">반</label>
          <select id="classNo">
            <option value="1">1반</option>
            <option value="2">2반</option>
            <option value="3">3반</option>
            <option value="4">4반</option>
            <option value="5">5반</option>
            <option value="6">6반</option>
            <option value="7">7반</option>
            <option value="8">8반</option>
          </select>
        </div>
      </div>

      <!-- classId는 더 이상 입력/표시하지 않음 (학년/반으로 자동 계산) -->

      <label for="set">세트(set)</label>
      <select id="set">
        <option value="" disabled selected>세트 목록 불러오는 중…</option>
      </select>
      <div id="setNote" class="note"></div>

      <div class="row">
        <div>
          <label for="sid">번호(sid)</label>
          <input id="sid" placeholder="예) 01" />
        </div>
        <div>
          <label for="name">이름</label>
          <input id="name" placeholder="예) 민수" />
        </div>
      </div>

      <div style="height:12px"></div>
      <button class="btn primary" id="goBtn">입장하기</button>
      <div class="muted">입력값을 기기에 저장하여 다음 접속 시 자동 채웁니다.</div>
    </div>
  </div>
</body>
</html>
