<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>철자 게임 입장</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Malgun Gothic", sans-serif; color-scheme: dark; }
    body { margin:0; background:#0f172a; color:#e5e7eb; display:grid; place-items:center; min-height:100vh; }
    .card { width:min(560px, 94vw); background:#0b1220; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:18px; }
    h1 { margin:0 0 14px; font-size:22px; }
    label{ font-size:13px; color:#93a4b5; }
    select, input{
      width:100%; padding:10px 12px; border:1px solid #334155; border-radius:10px;
      background:#0f172a; color:#fff; font-size:15px;
    }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .btn{ width:100%; border:1px solid #2563eb; background:#2563eb; color:#fff; padding:12px; border-radius:10px; font-weight:800; cursor:pointer; }
    .muted{ color:#9aa9b8; font-size:12px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>철자 게임 입장</h1>

    <div class="row">
      <div>
        <label>학년</label>
        <select id="grade">
          <option value="6">6학년</option>
          <option value="5">5학년</option>
          <option value="4">4학년</option>
        </select>
      </div>
      <div>
        <label>반</label>
        <select id="ban">
          <option value="1">1반</option><option value="2">2반</option>
          <option value="3">3반</option><option value="4">4반</option>
          <option value="5">5반</option><option value="6">6반</option>
          <option value="7">7반</option><option value="8">8반</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>공개 세트(set)</label>
      <select id="publicSet">
        <option value="">세트 목록 불러오는 중…</option>
      </select>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>번호(sid)</label>
        <input id="sid" placeholder="예) 01" />
      </div>
      <div>
        <label>이름</label>
        <input id="name" placeholder="예) 민수" />
      </div>
    </div>

    <button id="enter" class="btn" style="margin-top:14px;">입장하기</button>
    <div id="msg" class="muted">입력값은 기기에 저장되어 다음 접속 시 자동 채웁니다.</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCUmSDDcFn45Z_ZH3UigbsothE6iD21C7Y",
      authDomain: "grade-6-english-c17f3.firebaseapp.com",
      projectId: "grade-6-english-c17f3",
      storageBucket: "grade-6-english-c17f3.appspot.com",
      messagingSenderId: "676305839050",
      appId: "1:676305839050:web:a5399633e7b828883fe533"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const el = {
      grade: document.getElementById('grade'),
      ban: document.getElementById('ban'),
      publicSet: document.getElementById('publicSet'),
      sid: document.getElementById('sid'),
      name: document.getElementById('name'),
      msg: document.getElementById('msg')
    };

    // 저장된 값 채우기
    function loadLocal(){
      el.grade.value = localStorage.getItem('join.grade') || '6';
      el.ban.value   = localStorage.getItem('join.ban')   || '1';
      el.sid.value   = localStorage.getItem('join.sid')   || '';
      el.name.value  = localStorage.getItem('join.name')  || '';
    }
    function saveLocal(){
      localStorage.setItem('join.grade', el.grade.value);
      localStorage.setItem('join.ban', el.ban.value);
      localStorage.setItem('join.sid', el.sid.value.trim());
      localStorage.setItem('join.name', el.name.value.trim());
    }
    loadLocal();

    // 인증 → 공개 세트 목록 로드
    onAuthStateChanged(auth, async (u)=>{
      if (!u) { try{ await signInAnonymously(auth);}catch(e){ console.error(e);} return; }
      await loadPublicSets();
    });

    async function loadPublicSets(){
      el.publicSet.innerHTML = `<option value="">세트 목록 불러오는 중…</option>`;
      try{
        const qs = await getDocs(query(collection(db,'configs'), where('public','==', true)));
        const opts = [];
        qs.forEach(d=>{
          const data = d.data() || {};
          const label = data.set || d.id;
          opts.push({ id:d.id, label });
        });
        el.publicSet.innerHTML = opts.length
          ? opts.map(o=>`<option value="${o.id}">${o.label}</option>`).join('')
          : `<option value="">(공개 세트 없음)</option>`;
        el.msg.textContent = `공개 세트 ${opts.length}개 불러옴`;
      }catch(e){
        console.error(e);
        el.publicSet.innerHTML = `<option value="">(불러오기 오류)</option>`;
        el.msg.textContent = '세트 목록 불러오기 실패';
      }
    }

    document.getElementById('enter').addEventListener('click', ()=>{
      const cfgId = el.publicSet.value;
      const classId = `${el.grade.value}-${el.ban.value}`;
      const sid = el.sid.value.trim();
      const name = el.name.value.trim();

      if (!cfgId) { el.msg.textContent = '세트를 선택하세요.'; return; }
      if (!sid || !name){ el.msg.textContent = '번호/이름을 입력하세요.'; return; }

      saveLocal();
      const url = `game.html?cfg=${encodeURIComponent(cfgId)}&classId=${encodeURIComponent(classId)}&sid=${encodeURIComponent(sid)}&name=${encodeURIComponent(name)}`;
      location.href = url;
    });
  </script>
</body>
</html>
