<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì² ì ê²Œì„ ì…ì¥</title>
  <style>
    :root{ font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR","Malgun Gothic",sans-serif; color-scheme: dark; }
    body{ margin:0; background:#0b1220; color:#e5e7eb; min-height:100vh; display:grid; place-items:center; }
    .card{ width:min(720px,92vw); background:#0f172a; border:1px solid #334155; border-radius:16px; padding:20px; }
    h1{ margin:0 0 16px; font-size:24px; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    label{ display:block; margin:14px 0 6px; color:#a8b3c6; font-size:14px; }
    select,input{ width:100%; padding:10px 12px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; border-radius:10px; }
    .btn{ margin-top:16px; width:100%; padding:12px 14px; border:none; background:#2563eb; color:white; font-weight:700; border-radius:12px; cursor:pointer; }
    .muted{ margin-top:8px; color:#93a4b5; font-size:12px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ì² ì ê²Œì„ ì…ì¥</h1>

    <div class="row">
      <div>
        <label>í•™ë…„</label>
        <select id="gradeSel">
          <option value="6">6í•™ë…„</option>
          <option value="5">5í•™ë…„</option>
          <option value="4">4í•™ë…„</option>
          <option value="3">3í•™ë…„</option>
          <option value="2">2í•™ë…„</option>
          <option value="1">1í•™ë…„</option>
        </select>
      </div>
      <div>
        <label>ë°˜</label>
        <select id="classSel">
          <option value="1">1ë°˜</option><option value="2">2ë°˜</option>
          <option value="3" selected>3ë°˜</option><option value="4">4ë°˜</option>
          <option value="5">5ë°˜</option><option value="6">6ë°˜</option>
          <option value="7">7ë°˜</option><option value="8">8ë°˜</option>
        </select>
      </div>
    </div>

    <label style="margin-top:16px;">ê³µê°œ ì„¸íŠ¸(set)</label>
    <select id="publicSet">
      <option value="">(ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦)</option>
    </select>

    <div class="row">
      <div>
        <label>ë²ˆí˜¸(sid)</label>
        <input id="sid" type="text" value="51"/>
      </div>
      <div>
        <label>ì´ë¦„</label>
        <input id="name" type="text" value="ê¹€ë¯¼ì„œ"/>
      </div>
    </div>

    <button id="enter" class="btn">ì…ì¥í•˜ê¸°</button>
    <div id="msg" class="muted"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ğŸ”§ í”„ë¡œì íŠ¸ ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyCUmSDDcFn45Z_ZH3UigbsothE6iD21C7Y",
      authDomain: "grade-6-english-c17f3.firebaseapp.com",
      projectId: "grade-6-english-c17f3",
      storageBucket: "grade-6-english-c17f3.appspot.com",
      messagingSenderId: "676305839050",
      appId: "1:676305839050:web:a5399633e7b828883fe533"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const $ = (id)=> document.getElementById(id);
    const gradeSel = $("gradeSel");
    const classSel = $("classSel");
    const publicSet = $("publicSet");
    const sidEl = $("sid");
    const nameEl = $("name");
    const msgEl = $("msg");

    // ğŸ”„ ê³µê°œ ì„¸íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
    (async function loadPublicSets(){
      publicSet.innerHTML = `<option value="">(ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦)</option>`;
      try{
        const q = query(collection(db, "configs"), where("public", "==", true));
        const snap = await getDocs(q);

        const items = [];
        snap.forEach(d=>{
          const x = d.data();
          const classId = String(x.classId||"").trim(); // ì˜ˆ: "6-3"
          const set     = String(x.set||"").trim();     // ì˜ˆ: "í•œê¸€"
          if(!classId || !set) return;

          // valueëŠ” "classId_set" (ì˜ˆ: "6-3_í•œê¸€") â€” í‘œì‹œ ë¼ë²¨ì€ set
          items.push({ value: `${classId}_${set}`, label: set, classId });
        });

        items.sort((a,b)=> a.label.localeCompare(b.label, "ko"));
        publicSet.innerHTML = items.length
          ? `<option value="">(ì„¸íŠ¸ ì„ íƒ)</option>` + items.map(o=>`<option value="${o.value}">${o.label}</option>`).join("")
          : `<option value="">(ê³µê°œ ì„¸íŠ¸ ì—†ìŒ)</option>`;

        msgEl.textContent = `ê³µê°œ ì„¸íŠ¸ ${items.length}ê°œ ë¶ˆëŸ¬ì˜´`;

        // ì„¸íŠ¸ ì„ íƒ ì‹œ í•™ë…„/ë°˜ ë™ê¸°í™”
        publicSet.addEventListener("change", ()=>{
          const v = publicSet.value;
          if(!v || !v.includes("_")) return;
          const i = v.indexOf("_");
          const classId = v.slice(0, i);      // "6-3"
          const [g, c] = classId.split("-");
          if(g) gradeSel.value = g;
          if(c) classSel.value = c;
        });
      }catch(e){
        console.error(e);
        publicSet.innerHTML = `<option value="">(ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨)</option>`;
        msgEl.textContent = "ê³µê°œ ì„¸íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
      }
    })();

    // ğŸšª ì…ì¥í•˜ê¸°
    $("enter").addEventListener("click", ()=>{
      const sid  = sidEl.value.trim();
      const name = nameEl.value.trim();

      // publicSetì˜ value ì˜ˆ: "6-3_í•œê¸€" â†’ ì²« ë²ˆì§¸ '_' ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬ (ì„¸íŠ¸ëª…ì´ '_'ë¥¼ í¬í•¨í•´ë„ ì•ˆì „)
      let classId = `${gradeSel.value}-${classSel.value}`;
      let set = "";
      const v = publicSet.value.trim();

      if(v){
        const idx = v.indexOf("_");
        if(idx > 0){
          classId = v.slice(0, idx);
          set     = v.slice(idx + 1);
        }
      }
      if(!set){
        // ê³µê°œ ì„¸íŠ¸ ì„ íƒì´ ì—†ì„ ë•ŒëŠ” ì‚¬ìš©ìê°€ ê³ ë¥¸ í•™ë…„/ë°˜ ì¡°í•©ê³¼ ìˆ˜ë™ set ì…ë ¥ì´ í•„ìš”í•˜ì§€ë§Œ
        // í˜„ì¬ UIëŠ” ê³µê°œ ì„¸íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ìš´ì˜í•˜ë¯€ë¡œ ì•ˆë‚´ë§Œ í•©ë‹ˆë‹¤.
        alert("ê³µê°œ ì„¸íŠ¸ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }

      const params = new URLSearchParams({
        classId,
        set,
        sid,
        name
      });
      location.href = `game.html?${params.toString()}`;
    });
  </script>
</body>
</html>
