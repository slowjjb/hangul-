<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì² ì ê²Œì„ â€” í•™ìƒìš©</title>
<style>
  :root { --ink:#0f172a; --muted:#64748b; --border:#e2e8f0; --bg:#fff; --pill:#f1f5f9; --accent:#111827; }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;color:var(--ink);background:#fff}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);background:#fafafa}
  header h1{font-size:16px;margin:0;font-weight:800}
  .wrap{max-width:900px;margin:0 auto;padding:20px}
  .card{border:1px solid var(--border);border-radius:14px;padding:18px;background:#fff}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  input,select{padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px}
  button{appearance:none;border:1px solid #cbd5e1;background:#fff;color:#111827;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  button:active{transform:translateY(1px)}
  .hidden{display:none !important}
  .status{font-size:12px;color:var(--muted)}
  .word{font-size:40px;font-weight:900;letter-spacing:.3px;margin:18px 0;text-align:center}
  .pill{font-size:12px;background:var(--pill);border-radius:999px;padding:4px 8px;margin-right:6px}
  .center{display:flex;justify-content:center;gap:10px}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
<header>
  <h1>ì² ì ê²Œì„ â€” í•™ìƒìš©</h1>
  <div class="status" id="status">ì—°ê²° ì¤‘â€¦</div>
</header>

<div class="wrap">

  <!-- â‘  ì •ë³´ ì…ë ¥(í•„ìš”í•  ë•Œë§Œ) -->
  <section id="setupSection" class="card hidden">
    <h3>ì •ë³´ ì…ë ¥</h3>
    <div class="row">
      <input id="classId" placeholder="ë°˜(ex. 3-2)" />
      <input id="sid" placeholder="ë²ˆí˜¸(ex. 07)" />
      <input id="name" placeholder="ì´ë¦„(ì„ íƒ ê°€ëŠ¥)" />
      <input id="set" placeholder="ì„¸íŠ¸ ID(ex. lesson1)" />
    </div>
    <div class="row">
      <button class="primary" id="startBtn">ì‹œì‘</button>
    </div>
    <div class="hint">URLì— íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ì´ í™”ë©´ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. ë‹¤ìŒì—” ìë™ìœ¼ë¡œ ê¸°ì–µí•´ìš”.</div>
  </section>

  <!-- â‘¡ ê²Œì„ ì˜ì—­ -->
  <section id="gameSection" class="card hidden">
    <div>
      <span class="pill" id="pillClass">ë°˜ -</span>
      <span class="pill" id="pillSid">ë²ˆí˜¸ -</span>
      <span class="pill" id="pillName">ì´ë¦„ -</span>
      <span class="pill" id="pillSet">ì„¸íŠ¸ -</span>
    </div>
    <div class="word" id="word">ë‹¨ì–´</div>
    <div class="center">
      <button id="btnShow">ë‹¨ì–´ ë³´ê¸°</button>
      <button class="primary" id="btnCorrect">ë§ì·„ë‹¤ âœ”ï¸</button>
      <button id="btnWrong">ëª» ë§ì·„ë‹¤</button>
      <button id="btnNext">ë‹¤ìŒ</button>
    </div>
    <div class="hint" id="hint">ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ê²°ê³¼ê°€ Firestoreì— ì €ì¥ë©ë‹ˆë‹¤.</div>
  </section>

</div>

<script type="module">
// ---------- Firebase ----------
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// ğŸ”´ TODO: ë³¸ì¸ firebaseConfigë¡œ êµì²´í•˜ì„¸ìš”
const firebaseConfig = {
  apiKey: "AIzaSyCUmSDDcFn45Z_ZH3UigbsothE6iD21C7Y",
  authDomain: "grade-6-english-c17f3.firebaseapp.com",
  projectId: "grade-6-english-c17f3",
  storageBucket: "grade-6-english-c17f3.appspot.com",
  messagingSenderId: "676305839050",
  appId: "1:676305839050:web:a5399633e7b828883fe533"
};


const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---------- Helpers ----------
const $ = (id)=>document.getElementById(id);
const statusEl = $("status");
const url = new URL(location.href);
const qp = Object.fromEntries(url.searchParams.entries());
const LS_KEY = "classGame:v1";

function uuid(){
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c=>{
    const r = Math.random()*16|0, v = c==="x"?r:(r&0x3|0x8);
    return v.toString(16);
  });
}

async function loadSet(setId){
  const res = await fetch(`set/${encodeURIComponent(setId)}.json`, {cache:"no-cache"});
  if(!res.ok) throw new Error("ì„¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  const json = await res.json();
  if(!Array.isArray(json.words) || json.words.length===0) throw new Error("ì„¸íŠ¸ì— ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.");
  return json;
}

// ---------- State ----------
let state = {
  classId: qp.classId || "",
  sid: qp.sid || "",
  name: qp.name || "",
  set: qp.set || "",
  words: [],
  current: "",
  shownAt: 0
};

// ---------- UI ----------
const setupSection = $("setupSection");
const gameSection = $("gameSection");
const wordEl = $("word");
const pillClass = $("pillClass");
const pillSid = $("pillSid");
const pillName = $("pillName");
const pillSet = $("pillSet");

function needSetup(){
  return !(state.classId && state.sid && state.set);
}

function fillPills(){
  pillClass.textContent = `ë°˜ ${state.classId}`;
  pillSid.textContent = `ë²ˆí˜¸ ${state.sid}`;
  pillName.textContent = `ì´ë¦„ ${state.name || "-"}`;
  pillSet.textContent = `ì„¸íŠ¸ ${state.set}`;
}

function showSetup(){
  setupSection.classList.remove("hidden");
  gameSection.classList.add("hidden");
  $("classId").value = state.classId;
  $("sid").value = state.sid;
  $("name").value = state.name;
  $("set").value = state.set || "lesson1";
}

function showGame(){
  setupSection.classList.add("hidden");
  gameSection.classList.remove("hidden");
  fillPills();
}

// ---------- Game flow ----------
function pick(){
  if(!state.words.length) return "";
  return state.words[Math.floor(Math.random()*state.words.length)];
}

function showNextWord(){
  state.current = pick();
  wordEl.textContent = state.current || "â€”";
  state.shownAt = performance.now();
}

async function saveResult(correct){
  try{
    const durationMs = Math.max(0, Math.round(performance.now() - (state.shownAt||performance.now())));
    const payload = {
      classId: state.classId,
      studentId: state.sid,
      name: state.name || null,
      set: state.set,
      word: state.current,
      correct: !!correct,
      durationMs,
      attemptId: uuid(),
      createdAt: serverTimestamp(),
      version: "v1.0"
    };
    await addDoc(collection(db, "results"), payload);
    $("hint").textContent = "ì €ì¥ë¨ âœ…";
  }catch(e){
    $("hint").textContent = "ì €ì¥ ì‹¤íŒ¨ âš ï¸ ì½˜ì†” í™•ì¸";
    console.error(e);
  }
}

// ---------- Events ----------
$("startBtn").addEventListener("click", async ()=>{
  state.classId = $("classId").value.trim();
  state.sid = $("sid").value.trim();
  state.name = $("name").value.trim();
  state.set = $("set").value.trim() || "lesson1";
  if(!state.classId || !state.sid || !state.set){ alert("ë°˜/ë²ˆí˜¸/ì„¸íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
  localStorage.setItem(LS_KEY, JSON.stringify({classId:state.classId,sid:state.sid,name:state.name,set:state.set}));
  await bootAndStart();
});

$("btnShow").addEventListener("click", showNextWord);
$("btnCorrect").addEventListener("click", ()=> saveResult(true));
$("btnWrong").addEventListener("click", ()=> saveResult(false));
$("btnNext").addEventListener("click", showNextWord);

// ---------- Boot ----------
async function bootAndStart(){
  try{
    statusEl.textContent = "ì„¸íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
    const set = await loadSet(state.set);
    state.words = set.words;
    statusEl.textContent = "ì¤€ë¹„ ì™„ë£Œ";
    showGame();
    showNextWord();
  }catch(e){
    statusEl.textContent = "ì„¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨";
    alert(e.message);
    showSetup();
  }
}

onAuthStateChanged(auth, async (u)=>{
  if(u){
    statusEl.textContent = "Firebase ì—°ê²°ë¨ ğŸ”Œ";
    // íŒŒë¼ë¯¸í„°/ë¡œì»¬ ë³µêµ¬
    if(needSetup()){
      try{
        const memo = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
        state = {...state, ...memo};
      }catch{}
    }
    if(needSetup()) showSetup();
    else await bootAndStart();
  }
});
signInAnonymously(auth).catch(err=>{
  statusEl.textContent = "ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨";
  console.error(err);
});
</script>
</body>
</html>
